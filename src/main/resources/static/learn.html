<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LingoLearn | AI Powered</title>
    <style>
      :root {
        --primary: #6366f1;
        --primary-light: #e0e7ff;
        --secondary: #ec4899;
        --bg: #f8fafc;
        --text-dark: #1e293b;
        --text-light: #64748b;
        --white: #ffffff;
        --shadow:
          0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        --radius: 12px;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family:
          "Inter",
          system-ui,
          -apple-system,
          sans-serif;
      }

      body {
        background-color: var(--bg);
        color: var(--text-dark);
        line-height: 1.6;
        padding: 2rem 1rem;
      }

      .container {
        max-width: 1000px;
        margin: 0 auto;
        position: relative;
        transition: max-width 0.3s ease, margin 0.3s ease;
      }

      body.fullscreen-mode .container {
        max-width: 98%;
        margin: 0 1%;
      }

      header {
        text-align: center;
        margin-bottom: 3rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
      }

      header h1 {
        font-size: 2.5rem;
        color: var(--primary);
        margin-bottom: 0.2rem;
      }

      .top-controls {
        display: flex;
        gap: 8px;
        align-items: center;
        background: var(--white);
        padding: 8px 14px;
        border-radius: 20px;
        box-shadow: var(--shadow);
        margin-bottom: 1rem;
        flex-wrap: wrap;
        justify-content: center;
      }

      select,
      .lang-checkbox-group {
        padding: 6px 12px;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        outline: none;
        cursor: pointer;
        background: white;
      }

      .lang-checkbox-group {
        display: flex;
        gap: 15px;
        padding: 8px 16px;
        font-size: 0.9rem;
        align-items: center;
      }

      .lang-checkbox-group label {
        display: flex;
        align-items: center;
        gap: 5px;
        cursor: pointer;
        font-weight: 600;
      }

      .lang-checkbox-group input {
        cursor: pointer;
      }

      /* Color Coding for Languages */
      .color-en {
        color: #4338ca;
      } /* Indigo */
      .color-hi {
        color: #b91c1c;
      } /* Red */
      .color-te {
        color: #047857;
      } /* Emerald */
      .color-fr {
        color: #c2410c;
      } /* Orange */
      .color-es {
        color: #be185d;
      } /* Pink */

      /* Global Language Toggles */
      body:not(.show-en) .lang-en { display: none !important; }
      body:not(.show-hi) .lang-hi { display: none !important; }
      body:not(.show-te) .lang-te { display: none !important; }

      /* Input Section */
      #input-container {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        margin-bottom: 4rem;
      }

      .row-wrapper {
        background: var(--white);
        padding: 1.5rem;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        border: 1px solid #e2e8f0;
        position: relative;
      }

      .input-row {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-bottom: 1rem;
      }

      .input-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }

      input[type="text"],
      textarea {
        flex: 1;
        padding: 12px 16px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 1rem;
        outline: none;
        transition: border-color 0.2s;
        font-family:
          "Inter",
          system-ui,
          -apple-system,
          sans-serif;
      }

      textarea {
        resize: none;
        min-height: 45px;
        overflow-y: auto;
        line-height: 1.5;
        margin-bottom: 0 !important;
        border-bottom-left-radius: 0;
        border-bottom-right-radius: 0;
        border-bottom: none;
      }
      
      .resize-handle {
        width: 100%;
        height: 12px;
        background: #f1f5f9;
        border: 2px solid #e2e8f0;
        border-top: 1px dashed #cbd5e1;
        border-bottom-left-radius: 8px;
        border-bottom-right-radius: 8px;
        cursor: row-resize;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
        margin-bottom: 12px;
      }
      
      .resize-handle:hover {
        background: #e2e8f0;
      }
      
      .resize-handle::after {
        content: "";
        width: 30px;
        height: 2px;
        background: #94a3b8;
        border-radius: 2px;
        box-shadow: 0 4px 0 #94a3b8;
        margin-top: -4px;
      }

      input[type="text"]:focus,
      textarea:focus {
        border-color: var(--primary);
      }

      .btn-add {
        background: var(--primary);
        color: white;
        border: none;
        width: 45px;
        height: 45px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
      }

      .btn-remove {
        background: #ef4444 !important; /* Red */
      }

      .btn-add:hover {
        transform: scale(1.05);
        opacity: 0.9;
      }

      /* Dropdown Menus */
      .user-menu-container {
        position: relative;
        display: inline-block;
      }
      .user-badge-btn {
        background: var(--primary-light);
        color: var(--primary);
        padding: 0 12px;
        height: 32px;
        display: flex;
        align-items: center;
        gap: 6px;
        border-radius: 16px;
        font-weight: 600;
        font-size: 0.85rem;
        cursor: pointer;
        border: 1px solid #c7d2fe;
        transition: all 0.2s;
        display: none; /* hidden until auth */
      }
      .user-badge-btn:hover {
        background: #c7d2fe;
      }
      .user-dropdown-menu {
        position: absolute;
        top: 40px;
        right: 0;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        min-width: 140px;
        display: none;
        flex-direction: column;
        overflow: hidden;
        z-index: 10000;
        border: 1px solid #e5e7eb;
      }
      .user-dropdown-menu.show {
        display: flex;
        animation: slideDown 0.15s ease-out;
      }
      .user-dropdown-btn {
        padding: 10px 15px;
        border: none;
        background: none;
        text-align: left;
        font-weight: 500;
        cursor: pointer;
        font-size: 0.9rem;
        color: #374151;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: background 0.2s;
        width: 100%;
      }
      .user-dropdown-btn:hover {
        background: #f3f4f6;
      }
      .sarvam-menu {
        position: absolute;
        top: 100%;
        left: 0;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        display: none;
        flex-direction: column;
        z-index: 10000;
        border: 1px solid #e5e7eb;
        min-width: 180px;
        margin-top: 5px;
        padding: 4px 0;
      }
      .sarvam-menu.show {
        display: flex;
        animation: slideDown 0.15s ease-out;
      }
      .sarvam-menu-item {
        padding: 8px 12px;
        border: none;
        background: none;
        text-align: left;
        font-size: 0.85rem;
        color: #374151;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        width: 100%;
      }
      .sarvam-menu-item:hover {
        background: #f3f4f6;
        color: var(--primary);
      }
      
      @keyframes slideDown {
        from { opacity: 0; transform: translateY(-5px); }
        to { opacity: 1; transform: translateY(0); }
      }

      /* Translation Output - Horizontal Line-by-Line (Default Vertical List) */
      .translation-box {
        display: flex;
        flex-direction: column;
        gap: 0.8rem;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px dotted #e2e8f0;
        transition: all 0.3s;
      }

      /* Side-by-Side (Horizontal Grid) */
      .inner-translation-box.side-by-side {
        display: flex !important;
        flex-direction: row !important;
        flex-wrap: nowrap;
        gap: 1rem;
        align-items: flex-start;
      }

      .inner-translation-box.side-by-side .translation-line {
        flex: 1;
        min-width: 0;
        flex-direction: column;
        align-items: flex-start;
        background: #f8fafc;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
      }

      .translation-line {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 4px 0;
      }

      .lang-tag {
        font-size: 0.65rem;
        font-weight: 800;
        padding: 3px 7px;
        border-radius: 5px;
        min-width: 32px;
        text-align: center;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        flex-shrink: 0;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      }
      .lang-tag:hover {
        transform: scale(1.05);
        opacity: 0.9;
      }
      .lang-tag:active {
        transform: scale(0.95);
      }
      .lang-tag-en {
        background: #e0e7ff;
        color: #4338ca;
      }
      .lang-tag-hi {
        background: #fee2e2;
        color: #b91c1c;
      }
      .lang-tag-te {
        background: #d1fae5;
        color: #047857;
      }

      .lang-group {
        display: flex;
        align-items: center;
        width: 100%;
      }

      .sentence {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        align-items: center; /* Align speaker icon with text */
      }

      .sentence-text {
        font-size: 1.1rem;
        font-weight: 600;
      }

      .btn-speak-sentence {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1.2rem;
        padding: 4px;
        border-radius: 50%;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--primary);
      }

      .btn-speak-sentence:hover {
        background: var(--primary-light);
        transform: scale(1.1);
      }

      /* Word Interaction */
      .word {
        display: inline-block;
        padding: 4px 8px;
        background: #f1f5f9;
        border-radius: 6px;
        cursor: help;
        transition: all 0.2s;
        position: relative;
        font-weight: 500;
        white-space: nowrap; /* Prevent splitting words */
      }

      /* Buffer to bridge the gap between word and tooltip */
      .word::after {
        content: "";
        position: absolute;
        top: -20px;
        left: 0;
        right: 0;
        height: 25px;
        display: none;
      }

      .word:hover::after {
        display: block;
      }

      .word:hover {
        background-color: var(--primary-light);
        color: var(--primary);
        transform: translateY(-2px);
      }

      /* Tooltip */
      .tooltip {
        position: absolute;
        bottom: calc(100% + 10px);
        left: 50%;
        transform: translateX(-50%);
        background: var(--white);
        border-radius: 12px;
        padding: 10px;
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        white-space: nowrap;
        border: 1px solid #e2e8f0;
        gap: 10px;
        
        display: flex;
        flex-direction: column;
        align-items: center;
        visibility: hidden;
        opacity: 0;
        transition: visibility 0s linear 2s, opacity 0.2s linear 2s;
      }

      .tooltip::before {
        content: "";
        position: absolute;
        top: 100%;
        left: 0;
        width: 100%;
        height: 15px;
        background: transparent;
      }

      .word:hover .tooltip,
      .tooltip:hover {
        visibility: visible;
        opacity: 1;
        transition-delay: 0s;
      }
      
      .tooltip-pos {
        font-size: 0.8rem;
        color: var(--primary);
        font-weight: 600;
        text-transform: uppercase;
        margin-bottom: -5px;
      }
      
      .tooltip-btn-group {
         display: flex;
         gap: 10px;
      }

      .tooltip button {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        cursor: pointer;
        font-size: 1.4rem;
        padding: 8px;
        border-radius: 10px;
        transition: all 0.2s;
      }

      .tooltip button:hover {
        background: var(--primary-light);
        border-color: var(--primary);
        transform: scale(1.1);
      }

      /* Loading Spinner */
      .loader {
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        display: inline-block;
        margin-left: 10px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Dictionary Table */
      .dictionary-section {
        margin-top: 5rem;
        background: var(--white);
        padding: 2rem;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
      }

      .dictionary-section h2 {
        margin-bottom: 1.5rem;
        color: var(--text-dark);
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      th,
      td {
        text-align: left;
        padding: 16px;
        border-bottom: 1px solid #f1f5f9;
      }

      th {
        background-color: #f8fafc;
        color: var(--text-light);
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.85rem;
      }

      @media (max-width: 600px) {
        .translation-box {
          grid-template-columns: 1fr;
        }
      }

      /* Quiz Section */
      .quiz-container {
        margin-top: 15px;
        padding: 15px;
        background: #f8fafc;
        border-radius: 12px;
        border-left: 4px solid var(--primary);
        display: none;
      }
      .quiz-level-selector {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        align-items: center;
        flex-wrap: wrap;
      }
      .level-btn {
        padding: 5px 12px;
        border-radius: 20px;
        border: 1px solid #e2e8f0;
        background: white;
        cursor: pointer;
        font-size: 0.85rem;
        transition: all 0.2s;
      }
      .level-btn:hover {
        background: var(--primary-light);
      }
      .level-btn.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
      }

      /* Story Generator Styles */
      .story-btn-wrapper {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 10;
        display: flex;
        align-items: center;
      }
      .btn-story {
        background: #8b5cf6 !important;
        width: 38px !important;
        height: 38px !important;
        font-size: 1.2rem !important;
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
      }
      .story-level-selector {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        background: white;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        border-radius: 12px;
        padding: 10px;
        z-index: 1000;
        border: 1px solid #e2e8f0;
        flex-direction: column;
        gap: 4px;
        width: 180px;
        margin-top: 8px;
      }
      .story-level-selector.show {
        display: flex;
      }
      .story-level-btn {
        text-align: left;
        padding: 8px 12px;
        border: none;
        background: none;
        cursor: pointer;
        border-radius: 6px;
        font-size: 0.85rem;
        color: var(--text-dark);
        transition: all 0.2s;
      }
      .story-level-btn:hover {
        background: var(--primary-light);
        color: var(--primary);
      }
      .story-level-btn span {
        font-size: 0.75rem;
        color: var(--text-light);
        display: block;
      }
      .quiz-question {
        margin-bottom: 20px;
        padding: 10px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .quiz-question h4 {
        margin-bottom: 10px;
        color: var(--text-dark);
        font-size: 0.95rem;
      }
      .quiz-choices {
        display: grid;
        grid-template-columns: 1fr;
        gap: 8px;
      }
      .choice-btn {
        text-align: left;
        padding: 10px 14px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        background: white;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.2s;
      }
      .choice-btn:hover:not(.disabled) {
        background: #f1f5f9;
        border-color: var(--primary);
      }
      .choice-btn.correct {
        background: #dcfce7;
        border-color: #22c55e;
        color: #166534;
      }
      .choice-btn.incorrect {
        background: #fee2e2;
        border-color: #ef4444;
        color: #991b1b;
      }
      .choice-btn.disabled {
        cursor: default;
        opacity: 0.8;
      }
      .quiz-feedback {
        margin-top: 8px;
        font-size: 0.85rem;
        font-weight: 500;
        display: none;
      }

      /* Modal Styles */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        -webkit-backdrop-filter: blur(4px);
        backdrop-filter: blur(4px);
      }

      .modal-content {
        background: white;
        padding: 2rem;
        border-radius: 16px;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        position: relative;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        border-bottom: 1px solid #f1f5f9;
        padding-bottom: 1rem;
      }

      .modal-header h3 {
        font-size: 1.5rem;
        color: var(--primary);
      }

      .btn-close {
        background: #f1f5f9;
        border: 1px solid #e2e8f0;
        font-size: 1.2rem;
        cursor: pointer;
        color: var(--text-light);
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
      }
      .btn-close:hover {
        background: #fee2e2;
        color: #ef4444;
        border-color: #ef4444;
      }

      /* Config / Settings Modal Styles */
      .config-input-row {
          display: flex;
          flex-direction: column;
          gap: 5px;
          margin-bottom: 15px;
      }
      .config-input-row label {
          font-weight: 600;
          font-size: 0.9rem;
          color: #1e293b;
      }
      .config-input-row input {
          width: 100%;
          padding: 10px;
          border: 1px solid #cbd5e1;
          border-radius: 6px;
          font-family: monospace;
          transition: border-color 0.2s;
      }
      .config-input-row input:focus {
          border-color: var(--primary);
          outline: none;
      }

      /* Styled close (√ó) span in modal */
      .close-modal {
        position: absolute;
        top: 14px;
        right: 14px;
        font-size: 1.6rem;
        line-height: 1;
        cursor: pointer;
        color: var(--text-light);
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background: #f1f5f9;
        border: 1px solid #e2e8f0;
        transition: all 0.2s;
      }
      .close-modal:hover {
        background: #fee2e2;
        color: #ef4444;
        border-color: #ef4444;
      }

      .usage-list {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }

      .usage-item {
        padding: 1rem;
        background: #f8fafc;
        border-radius: 12px;
        border-left: 4px solid var(--primary);
      }

      .usage-en {
        font-weight: 700;
        font-size: 1.1rem;
        display: block;
        margin-bottom: 0.5rem;
        color: #1e293b;
      }

      .usage-trans {
        display: block;
        font-size: 0.95rem;
        margin-top: 4px;
      }

      .usage-label {
        font-size: 0.7rem;
        font-weight: 800;
        text-transform: uppercase;
        color: var(--text-light);
        margin-right: 6px;
      }

      .pos-tag {
        color: #ef4444; /* Red */
        font-weight: 800;
        text-transform: uppercase;
        font-size: 0.9rem;
        margin-left: 10px;
      }

      .usage-line {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .tense-section {
        margin-top: 2rem;
        border-top: 2px solid #f1f5f9;
        padding-top: 1.5rem;
      }

      .tense-section h4 {
        font-size: 1.2rem;
        color: #1e293b;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .tense-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .tense-card {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 1rem;
        transition: all 0.2s;
      }

      .tense-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        border-color: var(--primary);
      }

      .tense-badge {
        font-size: 0.6rem;
        font-weight: 850;
        padding: 2px 6px;
        border-radius: 4px;
        background: var(--primary-light);
        color: var(--primary);
        text-transform: uppercase;
        margin-bottom: 8px;
        display: inline-block;
      }

      .btn-advanced {
        margin-top: 1rem;
        background: none;
        border: 1px solid var(--primary);
        color: var(--primary);
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 6px;
        width: fit-content;
      }

      .btn-advanced:hover {
        background: var(--primary);
        color: white;
      }

      .advanced-tense-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1rem;
        margin-top: 1.5rem;
      }

      .tense-group-header {
        font-size: 0.9rem;
        font-weight: 800;
        color: var(--text-light);
        text-transform: uppercase;
        margin-bottom: 10px;
        grid-column: 1 / -1;
        padding-bottom: 5px;
        border-bottom: 2px solid #f1f5f9;
      }

      .target-word-highlight {
        background-color: #ff007f; /* Neon Pink */
        color: #fff;
        padding: 1px 6px;
        border-radius: 4px;
        font-weight: 850;
        box-shadow: 0 2px 8px rgba(255, 0, 127, 0.4);
        border: 1px solid #d9006b;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
      }

      .modal-title-box {
        background: #f8fafc;
        padding: 16px 24px;
        border-radius: 16px;
        margin-bottom: 24px;
        border-left: 6px solid #2563eb; /* Blue accent */
        display: flex;
        align-items: center;
        gap: 16px;
        box-shadow: var(--shadow-sm);
      }

      .modal-title-text {
        font-size: 1.5rem;
        font-weight: 850;
        color: #1e293b;
        letter-spacing: -0.02em;
      }

      .modal-word-title {
        color: #2563eb; /* Specific Blue */
        font-weight: 900;
      }

      .pos-badge {
        background: #7c3aed; /* Vibrant Violet */
        color: white;
        padding: 4px 14px;
        border-radius: 30px;
        font-size: 0.8rem;
        text-transform: uppercase;
        font-weight: 850;
        display: inline-block;
      }

      .vocab-trigger-btn {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 6px;
        font-size: 0.78rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s;
      }

      .vocab-trigger-btn:hover:not(:disabled) {
        opacity: 0.85;
      }

      .vocab-trigger-btn:disabled {
        background: #94a3b8;
        cursor: not-allowed;
      }

      .trans-word {
        display: inline;
        border-radius: 3px;
        padding: 1px 2px;
        cursor: default;
        transition: background 0.15s;
      }
      .trans-word:hover {
        background: rgba(99, 102, 241, 0.15);
      }
      .trans-word.cross-highlight {
        background: rgba(251, 191, 36, 0.45);
        border-radius: 3px;
        outline: 1px solid rgba(251, 191, 36, 0.7);
      }

      .action-bar-container {
        min-height: 36px; /* Reserve space even before bar is rendered */
      }

      .row-action-bar {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 6px 0 4px 0;
        border-bottom: 1px solid #e2e8f0;
        margin-bottom: 10px;
        flex-wrap: wrap;
      }

      .row-action-btn {
        background: #f1f5f9;
        border: 1px solid #cbd5e1;
        padding: 4px 9px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.78rem;
        font-weight: 600;
        color: #475569;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 4px;
      }
      .row-action-btn:hover {
        background: #e2e8f0;
      }
      .row-action-btn.active {
        background: #2563eb;
        color: white;
        border-color: #2563eb;
      }
      .tts-highlight {
        background-color: #fef08a !important;
        border-radius: 4px;
        color: #854d0e !important;
        transition: background-color 0.1s;
      }
      .row-action-btn.print-btn {
        background: #3b82f6;
        color: white;
        border-color: #3b82f6;
      }
      .row-action-btn.print-btn:hover {
        background: #2563eb;
      }

      .row-select-label {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 0.78rem;
        color: #64748b;
        cursor: pointer;
      }
      .row-select-label input {
        cursor: pointer;
      }

      .row-wrapper.print-selected {
        outline: 2px solid #3b82f6;
        border-radius: 10px;
      }

      /* Print Specific Styling */
      @media print {
        @page {
          margin: 0; /* Removes default browser headers/footers */
        }
        html,
        body {
          background: white !important;
          margin: 0 !important;
          padding: 10mm 15mm !important; /* Re-add margin via padding so content doesn't hit the physical paper edge */
          color: black !important;
        }
        .no-print,
        .btn-speak-sentence {
          display: none !important;
        }
        .print-only-footer {
          display: block !important;
          position: fixed;
          bottom: 0;
          left: 0;
          width: 100%;
          text-align: center;
          font-size: 12px;
          color: #64748b !important;
          padding-bottom: 20px;
          border-top: 1px solid #e2e8f0;
          padding-top: 5px;
          background: white !important;
        }
        .container {
          box-shadow: none !important;
          max-width: 100% !important;
          margin: 0 !important;
          padding: 5px !important;
        }
        header,
        .top-controls,
        .input-row,
        .row-action-bar,
        .action-bar-container {
          display: none !important;
        }
        .dictionary-section {
          display: block !important;
          margin-top: 20px !important;
          background: white !important;
          padding: 0 !important;
          box-shadow: none !important;
          border: none !important;
        }
        /* Hide the section title in print if everything inside is hidden */
        .dictionary-section h2 {
          margin-top: 0;
          color: black !important;
        }

        #vocab-table th,
        #vocab-table td {
          background: white !important;
          color: black !important;
          border-bottom: 1px solid black !important;
        }
        #vocab-table th {
          border-bottom-width: 2px !important;
        }

        /* Hide unselected vocab rows */
        #vocab-table tr:not(.vocab-print-selected):not(#vocab-header) {
          display: none !important;
        }
        /* Hide the whole table if no rows are selected (header only) */
        #vocab-table:not(:has(.vocab-print-selected)) {
          display: none !important;
        }
        #vocab-table:not(:has(.vocab-print-selected)) ~ h2 {
          display: none !important;
        }

        /* Hide the selection column (first column) in print */
        #vocab-table th:first-child,
        #vocab-table td:first-child {
          display: none !important;
        }

        .word {
          background: transparent !important;
          color: black !important;
          padding: 0 !important;
          border: none !important;
          transform: none !important;
        }

        /* Hide ALL rows by default; show only selected ones */
        .row-wrapper {
          display: none !important;
        }
        .row-wrapper.print-selected {
          display: block !important;
          background: white !important;
          color: black !important;
          margin: 0 0 16px 0 !important;
          padding: 0 !important;
          outline: none !important;
          border: none !important;
          box-shadow: none !important;
          page-break-inside: avoid;
        }
        .inner-translation-box {
          border: 1px solid black;
          padding: 8px;
          margin: 0;
          outline: none !important;
          background: white !important;
        }
        .color-en,
        .color-hi,
        .color-te {
          color: black !important;
        }
        #input-container {
          margin: 0 !important;
          padding: 0 !important;
        }
        * {
          -webkit-print-color-adjust: economy !important;
          print-color-adjust: economy !important;
        }

        /* Dictionary Print Styles */
        body.print-dict > *:not(#dictionary-modal) {
          display: none !important;
        }
        body.print-dict #dictionary-modal {
          position: static !important;
          display: block !important;
          background: white !important;
          width: 100% !important;
          height: auto !important;
          overflow: visible !important;
        }
        body.print-dict #dictionary-modal > div {
          width: 100% !important;
          height: auto !important;
          max-height: none !important;
          border-radius: 0 !important;
          box-shadow: none !important;
          margin: 0 !important;
          padding: 0 !important;
        }
        body.print-dict .close-modal,
        body.print-dict button,
        body.print-dict .no-print {
          display: none !important;
        }
        body.print-dict .print-bg-strip {
          background: transparent !important;
        }
        body.print-dict .print-bg-strip * {
          background: transparent !important;
        }
      }
      <style>
        /* History Modal Tabs */
        .history-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        border-bottom: 2px solid #e2e8f0;
        padding-bottom: 10px;
      }
      .history-tab {
        background: none;
        border: none;
        padding: 8px 16px;
        cursor: pointer;
        font-weight: 600;
        color: var(--text-light);
        border-radius: 8px;
        transition: all 0.2s;
      }
      .history-tab.active {
        background: var(--primary-light);
        color: var(--primary);
      }
      .history-content-pane {
        display: none;
      }
      .history-content-pane.active {
        display: block;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Top Left: Actions -->
      <div
        class="no-print"
        style="
          position: absolute;
          top: 10px;
          left: 10px;
          display: flex;
          gap: 10px;
          z-index: 9999;
        "
      >
        <button
          class="btn-add"
          style="
            width: auto;
            height: 28px;
            font-size: 0.85rem;
            padding: 0 10px;
            border-radius: 14px;
            background: #8b5cf6;
          "
          onclick="openHistoryModal()"
        >
          üïí History
        </button>
        <button
          class="btn-add"
          style="
            width: auto;
            height: 28px;
            font-size: 0.85rem;
            padding: 0 10px;
            border-radius: 14px;
            background: #ec4899;
          "
          onclick="openDictionaryModal()"
        >
          üîç Dictionary
        </button>
        <button
          class="btn-add"
          id="fullscreen-toggle-btn"
          style="
            width: auto;
            height: 28px;
            font-size: 0.85rem;
            padding: 0 10px;
            border-radius: 14px;
            background: #14b8a6;
          "
          onclick="toggleFullScreenContainer()"
        >
          ‚ÜîÔ∏è Expand
        </button>
      </div>

      <!-- Top Right: User & Logout -->
      <div
        style="
          position: absolute;
          top: 10px;
          right: 10px;
          display: flex;
          align-items: center;
          gap: 10px;
          z-index: 9999;
        "
        class="no-print"
      >
        <div class="user-menu-container">
          <div id="user-badge" class="user-badge-btn" onclick="toggleUserMenu(event)">
            üë§ <span id="username-display">User</span> ‚ñæ
          </div>
          <div id="user-dropdown" class="user-dropdown-menu">
            <button id="manage-users-btn" class="user-dropdown-btn" onclick="openAdminModal()" style="display:none;">üë• Manage Users</button>
            <div id="manage-users-divider" style="height: 1px; background: #e5e7eb; margin: 4px 0; display:none;"></div>
            <button class="user-dropdown-btn" onclick="openConfigModal()">‚öôÔ∏è Settings</button>
            <div style="height: 1px; background: #e5e7eb; margin: 4px 0;"></div>
            <button class="user-dropdown-btn" onclick="logoutUser(this)" style="color: #ef4444;">üö™ Logout</button>
          </div>
        </div>
      </div>
      <header>
        <h1>‚ú® LingoLearn AI</h1>
        <div class="top-controls">
          <span>Model:</span>
          <select id="provider-select">
            <option value="google">Google Translate (High Accuracy)</option>
            <option value="gemini">Google Gemini (1.5 Flash - Fast)</option>
            <option value="openai">OpenAI (GPT-4o-mini)</option>
            <option value="huggingface">Hugging Face (Qwen 2.5 72B)</option>
            <option value="grok">Grok (xAI)</option>
            <option value="sarvam">Sarvam AI (sarvam-m)</option>
          </select>

          <span style="margin-left: 10px">Vocab Model:</span>
          <select id="vocab-provider-select">
            <option value="google" selected>Google Translator (Free & Fast)</option>
            <option value="gemini">Google Gemini</option>
            <option value="huggingface">Hugging Face</option>
            <option value="openai">OpenAI</option>
            <option value="grok">Grok (xAI)</option>
            <option value="sarvam">Sarvam AI</option>
          </select>

          <span style="margin-left: 10px">Teacher Model:</span>
          <select id="teacher-provider-select">
            <option value="openai">OpenAI (Expert)</option>
            <option value="gemini">Google Gemini</option>
            <option value="sarvam" selected>Sarvam AI</option>
            <option value="huggingface">Hugging Face</option>
          </select>

          <span style="margin-left: 10px">Translate to:</span>
          <div class="lang-checkbox-group" id="lang-selector">
            <label><input type="checkbox" value="en" checked /> EN</label>
            <label><input type="checkbox" value="hi" checked /> HI</label>
            <label><input type="checkbox" value="te" checked /> TE</label>
          </div>

          <span style="margin-left: 10px">TTS Speed:</span>
          <select id="tts-speed-select">
            <option value="0.5">Slow (0.5x)</option>
            <option value="0.75">Slower (0.75x)</option>
            <option value="1" selected>Normal (1x)</option>
            <option value="1.25">Fast (1.25x)</option>
            <option value="1.5">Very Fast (1.5x)</option>
          </select>

          <span style="margin-left: 10px">Voice:</span>
          <select id="tts-voice-select" style="max-width: 150px;">
            <option value="">Auto (Default)</option>
          </select>
          
          <label style="margin-left:10px; display:inline-flex; align-items:center; gap:4px; font-size:0.85rem; cursor:pointer;" title="Highlight words as they are spoken">
              <input type="checkbox" id="tts-highlight-toggle" checked> Highlight Speaking
          </label>

        </div>
      </header>

      <div id="input-container"></div>

      <div
        class="dictionary-section"
        id="dictionary-section"
        style="display: none"
      >
        <h2>Vocabulary Builder</h2>
        <table id="vocab-table">
          <thead>
            <tr id="vocab-header">
              <th>English</th>
              <th>Meaning</th>
              <th>Hindi</th>
              <th>Telugu</th>
            </tr>
          </thead>
          <tbody id="vocab-body"></tbody>
        </table>
      </div>
    </div>

    <!-- Admin: Manage Users Modal -->
    <div id="admin-modal" class="modal-overlay" style="display:none;" onclick="if(event.target===this)closeAdminModal()">
      <div class="modal-content" style="max-width:900px;width:95%;max-height:90vh;">
        <div class="modal-header">
          <h2 style="color:#6366f1;">üë• Manage Users</h2>
          <button onclick="closeAdminModal()" style="background:none;border:none;font-size:1.5rem;cursor:pointer;color:#64748b;">&times;</button>
        </div>

        <!-- Users Table -->
        <div style="overflow-x:auto;">
          <table style="width:100%;border-collapse:collapse;font-size:0.9rem;">
            <thead>
              <tr style="background:#f8fafc;">
                <th style="padding:10px 14px;text-align:left;color:#64748b;font-weight:600;text-transform:uppercase;font-size:0.75rem;border-bottom:1px solid #e2e8f0;">Username</th>
                <th style="padding:10px 14px;text-align:left;color:#64748b;font-weight:600;text-transform:uppercase;font-size:0.75rem;border-bottom:1px solid #e2e8f0;">Full Name</th>
                <th style="padding:10px 14px;text-align:left;color:#64748b;font-weight:600;text-transform:uppercase;font-size:0.75rem;border-bottom:1px solid #e2e8f0;">Email</th>
                <th style="padding:10px 14px;text-align:left;color:#64748b;font-weight:600;text-transform:uppercase;font-size:0.75rem;border-bottom:1px solid #e2e8f0;">Phone</th>
                <th style="padding:10px 14px;text-align:left;color:#64748b;font-weight:600;text-transform:uppercase;font-size:0.75rem;border-bottom:1px solid #e2e8f0;">Role</th>
                <th style="padding:10px 14px;text-align:left;color:#64748b;font-weight:600;text-transform:uppercase;font-size:0.75rem;border-bottom:1px solid #e2e8f0;">Actions</th>
              </tr>
            </thead>
            <tbody id="admin-users-tbody">
              <tr><td colspan="6" style="text-align:center;color:#94a3b8;padding:20px;">Loading...</td></tr>
            </tbody>
          </table>
        </div>

        <!-- Edit Panel (appears below table) -->
        <div id="admin-edit-panel" style="display:none;margin-top:1.5rem;border-top:1px solid #e2e8f0;padding-top:1.5rem;">
          <h3 id="edit-user-title" style="color:#374151;margin-bottom:1rem;font-size:1rem;">Edit User</h3>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <div>
              <label style="display:block;font-size:0.85rem;font-weight:500;margin-bottom:4px;">First Name</label>
              <input id="edit-firstname" type="text" style="width:100%;padding:8px 12px;border:1px solid #e2e8f0;border-radius:6px;font-size:0.9rem;outline:none;">
            </div>
            <div>
              <label style="display:block;font-size:0.85rem;font-weight:500;margin-bottom:4px;">Last Name</label>
              <input id="edit-lastname" type="text" style="width:100%;padding:8px 12px;border:1px solid #e2e8f0;border-radius:6px;font-size:0.9rem;outline:none;">
            </div>
            <div>
              <label style="display:block;font-size:0.85rem;font-weight:500;margin-bottom:4px;">Email</label>
              <input id="edit-email" type="email" style="width:100%;padding:8px 12px;border:1px solid #e2e8f0;border-radius:6px;font-size:0.9rem;outline:none;">
            </div>
            <div>
              <label style="display:block;font-size:0.85rem;font-weight:500;margin-bottom:4px;">Phone Number</label>
              <input id="edit-phone" type="tel" style="width:100%;padding:8px 12px;border:1px solid #e2e8f0;border-radius:6px;font-size:0.9rem;outline:none;">
            </div>
            <div>
              <label style="display:block;font-size:0.85rem;font-weight:500;margin-bottom:4px;">Age</label>
              <input id="edit-age" type="number" style="width:100%;padding:8px 12px;border:1px solid #e2e8f0;border-radius:6px;font-size:0.9rem;outline:none;">
            </div>
            <div>
              <label style="display:block;font-size:0.85rem;font-weight:500;margin-bottom:4px;">Father's Name</label>
              <input id="edit-father" type="text" style="width:100%;padding:8px 12px;border:1px solid #e2e8f0;border-radius:6px;font-size:0.9rem;outline:none;">
            </div>
            <div>
              <label style="display:block;font-size:0.85rem;font-weight:500;margin-bottom:4px;">Mother's Name</label>
              <input id="edit-mother" type="text" style="width:100%;padding:8px 12px;border:1px solid #e2e8f0;border-radius:6px;font-size:0.9rem;outline:none;">
            </div>
            <div>
              <label style="display:block;font-size:0.85rem;font-weight:500;margin-bottom:4px;">New Password <span style="color:#94a3b8;font-weight:400;">(leave blank to keep)</span></label>
              <input id="edit-password" type="password" placeholder="Enter new password to reset" style="width:100%;padding:8px 12px;border:1px solid #e2e8f0;border-radius:6px;font-size:0.9rem;outline:none;">
            </div>
          </div>
          <div style="display:flex;gap:10px;margin-top:1rem;">
            <button onclick="saveEditUser()" style="background:#6366f1;color:white;border:none;padding:10px 24px;border-radius:8px;font-size:0.95rem;font-weight:600;cursor:pointer;">üíæ Save Changes</button>
            <button onclick="document.getElementById('admin-edit-panel').style.display='none'" style="background:#f1f5f9;color:#374151;border:1px solid #e2e8f0;padding:10px 24px;border-radius:8px;font-size:0.95rem;cursor:pointer;">Cancel</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Usage Examples Modal -->
    <div id="usage-modal" class="modal-overlay">
      <div class="modal-content">
        <span class="close-modal" onclick="closeModal()">&times;</span>

        <div class="modal-title-box">
          <span style="font-size: 1.5rem">üìñ</span>
          <div>
            <div class="modal-title-text">
              Sentence Usage of
              <span id="modal-word-display" class="modal-word-title">...</span>
            </div>
            <span id="modal-pos" class="pos-badge">...</span>
          </div>
        </div>

        <div id="modal-body" class="usage-section">
          <!-- General examples here -->
        </div>
        <div id="modal-tenses" class="tense-section" style="display: none">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
            "
          >
            <h4>‚è≥ Tense Explorer</h4>
            <button
              id="btn-show-advanced"
              class="btn-advanced"
              onclick="showAdvancedTenses()"
            >
              ‚ú® Advanced 12-Tense Matrix
            </button>
          </div>
          <div id="tense-body" class="tense-grid">
            <!-- Basic tense cards here -->
          </div>
          <div
            id="advanced-tense-body"
            class="advanced-tense-grid"
            style="display: none"
          >
            <!-- 12 Tense matrix cards here -->
          </div>
        </div>
      </div>
    </div>
    <!-- Dictionary Explorer Modal -->
    <div
      id="dictionary-modal"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10000;
        align-items: center;
        justify-content: center;
      "
    >
      <div
        style="
          background: white;
          width: 90%;
          max-width: 700px;
          max-height: 85vh;
          border-radius: 16px;
          display: flex;
          flex-direction: column;
          box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        "
      >
        <div
          style="
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fdf2f8;
            border-radius: 16px 16px 0 0;
          "
        >
          <h2
            style="
              margin: 0;
              color: #db2777;
              display: flex;
              align-items: center;
              gap: 10px;
            "
          >
            üîç Dictionary & Vocabulary Explorer
          </h2>
          <button
            onclick="closeDictionaryModal()"
            style="
              background: none;
              border: none;
              font-size: 1.5rem;
              cursor: pointer;
              color: var(--text-light);
            "
          >
            &times;
          </button>
        </div>

        <div style="padding: 20px; display: flex; gap: 10px; background: white">
          <input
            type="text"
            id="dict-search-input"
            placeholder="Type an English word or phrase to explore..."
            style="
              flex: 1;
              padding: 12px 16px;
              border: 2px solid #fbcfe8;
              border-radius: 8px;
              font-size: 1.1rem;
              outline: none;
            "
            onkeydown="if (event.key === 'Enter') searchDictionary();"
          />
          <button
            class="btn-add"
            style="
              background: #ec4899;
              width: auto;
              padding: 0 20px;
              font-size: 1rem;
            "
            onclick="searchDictionary()"
          >
            Search
          </button>
        </div>

        <div
          id="dictionary-content"
          style="
            padding: 0 20px 20px 20px;
            overflow-y: auto;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: white;
            border-radius: 0 0 16px 16px;
          "
        >
          <div style="text-align: center; color: #94a3b8; padding: 40px 0">
            <div style="font-size: 3rem; margin-bottom: 10px">üìñ</div>
            Search for a word to get its meaning, pronunciation, synonyms, and
            examples!
          </div>
        </div>
      </div>
    </div>
    
    <!-- Configuration / Settings Modal -->
    <div id="config-modal" class="modal-overlay">
      <div class="modal-content" style="max-width: 700px">
        <span class="close-modal" onclick="closeConfigModal()">&times;</span>
        <div class="modal-header" style="margin-bottom:1rem; border-bottom:1px solid #e2e8f0; padding-bottom:10px;">
          <h3 style="margin:0;">‚öôÔ∏è Application Configuration</h3>
        </div>
        
        <div style="font-size: 0.9rem; color: #64748b; margin-bottom: 20px;">
            Update your AI Provider API Keys securely in the database. 
            Modifying a key will <b>automatically restart</b> the backend to apply changes.
        </div>
        
        <div id="config-content" style="overflow-y: auto; max-height: 50vh; margin-bottom: 20px;">
             <!-- Loading State -->
             <div class="loader"></div>
        </div>

        <div style="display: flex; justify-content: flex-end; gap: 10px; border-top: 1px solid #e2e8f0; padding-top: 15px;">
            <button class="level-btn" onclick="closeConfigModal()">Cancel</button>
            <button class="level-btn active" id="btn-save-config" onclick="saveConfig()">Save & Restart</button>
        </div>
      </div>
    </div>

    <!-- History Modal -->
    <div
      id="history-modal"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10000;
        align-items: center;
        justify-content: center;
      "
    >
      <div
        style="
          background: white;
          width: 90%;
          max-width: 800px;
          max-height: 85vh;
          border-radius: 16px;
          display: flex;
          flex-direction: column;
          box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        "
      >
        <div
          style="
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
          "
        >
          <h2 style="margin: 0; color: var(--text-dark)">üìö Your History</h2>
          <button
            onclick="closeHistoryModal()"
            style="
              background: none;
              border: none;
              font-size: 1.5rem;
              cursor: pointer;
              color: var(--text-light);
            "
          >
            &times;
          </button>
        </div>

        <div style="padding: 20px 20px 0 20px">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 15px;
            "
          >
            <div
              class="history-tabs"
              style="margin-bottom: 0; border-bottom: none; padding-bottom: 0"
            >
              <button
                class="history-tab active"
                onclick="switchHistoryTab('tab-translations', this)"
              >
                Translations
              </button>
              <button
                class="history-tab"
                onclick="switchHistoryTab('tab-teacher', this)"
              >
                AI Teacher
              </button>
              <button
                class="history-tab"
                onclick="switchHistoryTab('tab-stories', this)"
              >
                Stories
              </button>
              <button
                class="history-tab"
                onclick="switchHistoryTab('tab-other', this)"
              >
                Other
              </button>
            </div>
            <div style="display: flex; gap: 10px">
              <button
                class="btn-add"
                style="
                  background: #3b82f6;
                  width: auto;
                  padding: 6px 15px;
                  font-size: 0.85rem;
                  border-radius: 8px;
                "
                onclick="toggleSelectAllHistory()"
              >
                ‚òëÔ∏è Select All
              </button>
              <button
                class="btn-add"
                style="
                  background: #10b981;
                  width: auto;
                  padding: 6px 15px;
                  font-size: 0.85rem;
                  border-radius: 8px;
                "
                onclick="printSelectedHistory()"
              >
                üñ®Ô∏è Print
              </button>
            </div>
          </div>
          <div
            style="border-bottom: 2px solid #e2e8f0; margin-bottom: 15px"
          ></div>
        </div>

        <div
          id="history-content"
          style="padding: 0 20px 20px 20px; overflow-y: auto; flex-grow: 1"
        >
          Loading...
          <div class="loader"></div>
        </div>
      </div>
    </div>

    <script>
      const state = {
        rowVocabulary: new Map(), // rowId -> Array of vocab objects
        wordTransCache: new Map(), // 'word|lang' -> translated string
        isSideBySide: false,
        vocabAbortControllers: new Map(), // rowId -> AbortController
        quizAbortControllers: new Map(), // rowId -> AbortController
      };

            function showBackendError(container, errData) {
        let msg = errData.error || errData.message || (typeof errData === 'string' ? errData : "An unknown error occurred");
        let uniqueId = 'trace-' + Math.random().toString(36).substring(2, 9);
        let traceHtml = errData.trace ? 
          `<div style="margin-top:10px;"><button onclick="document.getElementById('${uniqueId}').style.display = document.getElementById('${uniqueId}').style.display === 'none' ? 'block' : 'none';" style="background:none; border:none; color:#b91c1c; cursor:pointer; font-size:0.85rem; padding:0; text-decoration:underline;">Toggle Stack Trace</button><div id="${uniqueId}" style="margin-top:10px; font-size:0.75rem; color:#475569; background:#ffffff; padding:10px; border:1px solid #fecaca; border-radius:6px; display:none; white-space:pre-wrap; max-height:220px; overflow-y:auto; text-align:left; font-family:monospace;">${errData.trace}</div></div>` : '';
        
        container.innerHTML = `<div style="color:#b91c1c; background:#fef2f2; border:1px solid #fca5a5; padding:12px; border-radius:8px; margin-top:10px;">
            <div style="font-weight:600; margin-bottom:4px; font-size:1.05rem;">üõë Error</div>
            <div style="font-size:0.95rem;">${msg}</div>
            ${traceHtml}
        </div>`;
      }

      async function fetchUser() {
        try {
          const response = await fetch("/api/user/me");
          if (response.ok) {
            const data = await response.json();
            if (data.username) {
              document.getElementById("username-display").textContent = data.username;
              document.getElementById("user-badge").style.display = "block";
            }
            if (data.isAdmin) {
              document.getElementById("manage-users-btn").style.display = "flex";
              document.getElementById("manage-users-divider").style.display = "block";
            }
          }
        } catch (err) {
          console.error("Could not fetch user:", err);
        }
      }

      // ==================== ADMIN USER MANAGEMENT ====================
      let editingUserId = null;

      async function openAdminModal() {
        document.getElementById('user-dropdown').classList.remove('show');
        document.getElementById('admin-modal').style.display = 'flex';
        document.getElementById('admin-edit-panel').style.display = 'none';
        await loadAdminUsers();
      }

      function closeAdminModal() {
        document.getElementById('admin-modal').style.display = 'none';
      }

      let adminUsersMap = {}; // id -> user object

      async function loadAdminUsers() {
        const tbody = document.getElementById('admin-users-tbody');
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#94a3b8;">Loading...</td></tr>';
        adminUsersMap = {};
        try {
          const resp = await fetch('/api/admin/users');
          const users = await resp.json();
          if (!users.length) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#94a3b8;">No users found.</td></tr>';
            return;
          }
          users.forEach(u => { adminUsersMap[u.id] = u; });
          tbody.innerHTML = users.map(u => `
            <tr>
              <td><strong>${u.username || '-'}</strong></td>
              <td>${u.firstName || ''} ${u.lastName || ''}</td>
              <td>${u.email || '-'}</td>
              <td>${u.phoneNumber || '-'}</td>
              <td><span style="font-size:0.75rem;background:#e0e7ff;color:#4338ca;padding:2px 8px;border-radius:10px;">${(u.roles||[]).join(', ')}</span></td>
              <td style="display:flex;gap:8px;">
                <button data-user-id="${u.id}" class="admin-edit-btn" style="background:#6366f1;color:white;border:none;padding:5px 12px;border-radius:6px;cursor:pointer;font-size:0.8rem;">‚úèÔ∏è Edit</button>
                <button data-user-id="${u.id}" data-username="${u.username}" class="admin-delete-btn" style="background:#ef4444;color:white;border:none;padding:5px 12px;border-radius:6px;cursor:pointer;font-size:0.8rem;">üóëÔ∏è Delete</button>
              </td>
            </tr>`).join('');

          // Attach event listeners after render
          document.querySelectorAll('.admin-edit-btn').forEach(btn => {
            btn.addEventListener('click', () => openEditUser(adminUsersMap[btn.dataset.userId]));
          });
          document.querySelectorAll('.admin-delete-btn').forEach(btn => {
            btn.addEventListener('click', () => deleteAdminUser(btn.dataset.userId, btn.dataset.username));
          });
        } catch(e) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#ef4444;">Error loading users.</td></tr>';
        }
      }

      async function deleteAdminUser(id, username) {
        if (!confirm(`Delete user "${username}"? This cannot be undone.`)) return;
        try {
          const resp = await fetch(`/api/admin/users/${id}`, { method: 'DELETE' });
          if (resp.ok) {
            await loadAdminUsers();
          } else {
            alert('Failed to delete user.');
          }
        } catch(e) {
          alert('Error deleting user.');
        }
      }

      function openEditUser(user) {
        editingUserId = user.id;
        document.getElementById('edit-firstname').value = user.firstName || '';
        document.getElementById('edit-lastname').value  = user.lastName  || '';
        document.getElementById('edit-email').value     = user.email     || '';
        document.getElementById('edit-phone').value     = user.phoneNumber|| '';
        document.getElementById('edit-age').value       = user.age != null ? user.age : '';
        document.getElementById('edit-father').value    = user.fatherName || '';
        document.getElementById('edit-mother').value    = user.motherName || '';
        document.getElementById('edit-password').value  = '';
        document.getElementById('edit-user-title').textContent = `Edit: ${user.username}`;
        document.getElementById('admin-edit-panel').style.display = 'block';
        document.getElementById('admin-edit-panel').scrollIntoView({behavior:'smooth'});
      }

      async function saveEditUser() {
        if (!editingUserId) return;
        const body = {
          firstName:   document.getElementById('edit-firstname').value,
          lastName:    document.getElementById('edit-lastname').value,
          email:       document.getElementById('edit-email').value,
          phoneNumber: document.getElementById('edit-phone').value,
          age:         document.getElementById('edit-age').value ? parseInt(document.getElementById('edit-age').value) : null,
          fatherName:  document.getElementById('edit-father').value,
          motherName:  document.getElementById('edit-mother').value,
          newPassword: document.getElementById('edit-password').value || null
        };
        try {
          const resp = await fetch(`/api/admin/users/${editingUserId}`, {
            method: 'PUT',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(body)
          });
          if (resp.ok) {
            document.getElementById('admin-edit-panel').style.display = 'none';
            editingUserId = null;
            await loadAdminUsers();
          } else {
            alert('Failed to save changes.');
          }
        } catch(e) {
          alert('Error saving user.');
        }
      }

      async function saveHistory(actionType, content) {
        try {
          await fetch("/api/history", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ actionType, content }),
          });
        } catch (err) {
          console.error("Failed to save history", err);
        }
      }

      async function deleteHistory(id) {
        if (!confirm("Are you sure you want to remove this from your history?"))
          return;
        try {
          const response = await fetch(`/api/history/${id}`, {
            method: "DELETE",
          });
          if (response.ok) {
            await openHistoryModal(); // refresh
          } else {
            alert("Failed to delete history.");
          }
        } catch (err) {
          console.error("Delete failed", err);
          alert("Failed to delete history.");
        }
      }

      function switchHistoryTab(tabId, btn) {
        document
          .querySelectorAll(".history-tab")
          .forEach((t) => t.classList.remove("active"));
        document
          .querySelectorAll(".history-content-pane")
          .forEach((p) => p.classList.remove("active"));
        btn.classList.add("active");
        document.getElementById(tabId).classList.add("active");
      }

      function toggleSelectAllHistory() {
        const activePane = document.querySelector(
          ".history-content-pane.active",
        );
        if (!activePane) return;
        const checkboxes = activePane.querySelectorAll(".history-checkbox");
        const allChecked = Array.from(checkboxes).every((cb) => cb.checked);
        checkboxes.forEach((cb) => (cb.checked = !allChecked));
      }

      function printSelectedHistory() {
        const checkboxes = document.querySelectorAll(
          ".history-checkbox:checked",
        );
        if (checkboxes.length === 0) {
          alert("Please select at least one history item to print.");
          return;
        }

        let printContent = `
                <div style="font-family: sans-serif; padding: 20px; max-width: 800px; margin: 0 auto;">
                    <h2 style="color: #4f46e5; border-bottom: 2px solid #e5e7eb; padding-bottom: 10px;">üìö LingoLearn History Archive</h2>
            `;

        checkboxes.forEach((cb) => {
          const recordDiv = cb.closest(".history-record-item");
          const clone = recordDiv.cloneNode(true);
          // Remove the checkbox and delete button container
          const actionsCol = clone.querySelector(".history-actions-col");
          if (actionsCol) actionsCol.remove();

          printContent += `<div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e5e7eb; border-radius: 8px;">`;
          printContent += clone.innerHTML;
          printContent += `</div>`;
        });

        printContent += `</div>`;

        const printWindow = window.open("", "_blank", "height=600,width=800");
        printWindow.document.write("<html><head><title>Print History</title>");
        printWindow.document.write(
          "<style>body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }</style>",
        );
        printWindow.document.write("</head><body>");
        printWindow.document.write(printContent);
        printWindow.document.write("</body></html>");
        printWindow.document.close();

        // Wait for resources to load before printing
        setTimeout(() => {
          printWindow.focus();
          printWindow.print();
          printWindow.close();
        }, 500);
      }

      async function openHistoryModal() {
        document.getElementById("history-modal").style.display = "flex";
        const container = document.getElementById("history-content");
        container.innerHTML = 'Loading... <div class="loader"></div>';
        try {
          const response = await fetch("/api/history");
          const history = await response.json();

          if (history.length === 0) {
            container.innerHTML =
              '<p style="color:var(--text-light)">No history found yet. Try exploring the app!</p>';
            return;
          }

          // Group history by category
          const groups = {
            TRANSLATE: [],
            BETTER_WAY: [],
            STORY: [],
            OTHER: [],
          };

          history.forEach((record) => {
            if (record.actionType === "TRANSLATE")
              groups.TRANSLATE.push(record);
            else if (record.actionType === "BETTER_WAY")
              groups.BETTER_WAY.push(record);
            else if (record.actionType === "STORY") groups.STORY.push(record);
            else groups.OTHER.push(record);
          });

          const renderRecords = (records, emptyMsg) => {
            if (records.length === 0)
              return `<p style="color:var(--text-light)">${emptyMsg}</p>`;
            return records
              .map((record) => {
                const date = new Date(record.timestamp).toLocaleString();
                let contentHtml = "";
                if (
                  record.actionType === "TRANSLATE" ||
                  record.actionType === "BETTER_WAY"
                ) {
                  const c = record.content;
                  contentHtml = `<strong>Original:</strong> ${c.original || ""}<br>`;
                  if (c.translations) {
                    contentHtml += `<div style="background:#f1f5f9; padding:8px; border-radius:6px; margin-top:5px; font-size:0.9rem;">
                                    ${Object.entries(c.translations)
                                      .map(
                                        ([k, v]) =>
                                          `<b>${k.toUpperCase()}:</b> ${v}`,
                                      )
                                      .join("<br>")}
                                </div>`;
                  } else if (c.refined) {
                    contentHtml += `<div style="background:#f1f5f9; padding:8px; border-radius:6px; margin-top:5px; font-size:0.9rem;"><b>Refined:</b> ${c.refined}</div>`;
                  }
                } else if (record.actionType === "STORY") {
                  contentHtml = `<strong>Prompt:</strong> Level ${record.content.level}<br>
                             <div style="background:#f1f5f9; padding:8px; border-radius:6px; margin-top:5px; font-size:0.9rem;">
                                ${record.content.headline ? `<strong style="display:block;margin-bottom:6px;color:var(--primary)">[${record.content.headline}]</strong>` : ""}
                                ${record.content.story}
                             </div>`;
                } else {
                  contentHtml = `<pre style="font-size:0.8rem">${JSON.stringify(record.content, null, 2)}</pre>`;
                }

                return `
                            <div class="history-record-item" style="border-bottom: 1px solid #e2e8f0; padding:12px 0; display:flex; gap: 15px;">
                                <div class="history-actions-col" style="display:flex; flex-direction:column; align-items:center; gap: 15px; padding-top: 5px;">
                                    <input type="checkbox" class="history-checkbox" style="width: 18px; height: 18px; cursor: pointer;">
                                    <button onclick="deleteHistory('${record.id}')" style="background:none; border:none; color:#ef4444; font-size:1.1rem; cursor:pointer;" title="Remove">üóëÔ∏è</button>
                                </div>
                                <div style="flex-grow: 1;">
                                    <div style="margin-bottom:5px;">
                                        <span style="color:var(--text-light); font-size:0.8rem;">${date}</span>
                                    </div>
                                    <div>${contentHtml}</div>
                                </div>
                            </div>
                        `;
              })
              .join("");
          };

          container.innerHTML = `
                    <div id="tab-translations" class="history-content-pane active">
                        ${renderRecords(groups.TRANSLATE, "No translation history.")}
                    </div>
                    <div id="tab-teacher" class="history-content-pane">
                        ${renderRecords(groups.BETTER_WAY, "No AI Teacher history.")}
                    </div>
                    <div id="tab-stories" class="history-content-pane">
                        ${renderRecords(groups.STORY, "No story generation history.")}
                    </div>
                    <div id="tab-other" class="history-content-pane">
                        ${renderRecords(groups.OTHER, "No other history items.")}
                    </div>
                `;

          // Reset tabs state to first tab
          document.querySelectorAll(".history-tab")[0].click();
        } catch (e) {
          container.innerHTML = `<span style="color:red">Failed to load history</span>`;
        }
      }
      function closeHistoryModal() {
        document.getElementById("history-modal").style.display = "none";
      }

      /* Configuration Modal Scripts */
      async function openConfigModal() {
          document.getElementById('config-modal').style.display = 'flex';
          const container = document.getElementById('config-content');
          container.innerHTML = 'Loading Secrets from Database... <div class="loader"></div>';
          document.getElementById('btn-save-config').disabled = false;
          document.getElementById('btn-save-config').innerHTML = 'Save & Restart';
          
          try {
              const response = await fetch('/api/secrets');
              const secrets = await response.json();
              
              const keysToDisplay = [
                  "spring.ai.openai.api-key",
                  "spring.ai.huggingface.api-key",
                  "spring.ai.gemini.api-key",
                  "spring.ai.sarvam.api-key",
                  "spring.ai.grok.api-key"
              ];
              
              let html = '';
              for (const key of keysToDisplay) {
                  const val = secrets[key] || '';
                  const displayName = key.split('.')[2].toUpperCase(); // gets 'openai', 'huggingface', etc.
                  html += `
                      <div class="config-input-row">
                          <label>${displayName} API Key (${key})</label>
                          <input type="password" id="cfg_${key}" value="${val}" placeholder="Enter ${displayName} API Key..." />
                      </div>
                  `;
              }
              container.innerHTML = html;
          } catch(err) {
              container.innerHTML = `<div style="color:red; padding:10px;">Failed to load configuration: ${err.message}</div>`;
          }
      }

      function closeConfigModal() {
          document.getElementById('config-modal').style.display = 'none';
      }

      async function saveConfig() {
          const keysToDisplay = [
              "spring.ai.openai.api-key",
              "spring.ai.huggingface.api-key",
              "spring.ai.gemini.api-key",
              "spring.ai.sarvam.api-key",
              "spring.ai.grok.api-key"
          ];
          
          let payload = {};
          keysToDisplay.forEach(k => {
              const el = document.getElementById(`cfg_${k}`);
              if(el && el.value.trim() !== "") {
                  payload[k] = el.value.trim();
              }
          });

          const saveBtn = document.getElementById('btn-save-config');
          saveBtn.disabled = true;
          saveBtn.innerHTML = 'Saving... <div class="loader" style="width:12px; height:12px; border-width:2px; margin-left:5px;"></div>';

          try {
              const response = await fetch('/api/secrets', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(payload)
              });
              
              if(response.ok) {
                  document.getElementById('config-content').innerHTML = `
                      <div style="border: 1px solid #22c55e; background: #f0fdf4; color: #15803d; padding: 20px; border-radius: 8px; text-align: center;">
                          <h3 style="margin-top:0;">‚úÖ Configuration Saved</h3>
                          <p>The backend is restarting to apply changes.</p>
                          <p>The page will reload automatically in 5 seconds... <div class="loader" style="border-color:#22c55e; border-top-color:transparent;"></div></p>
                      </div>
                  `;
                  setTimeout(() => {
                      window.location.reload();
                  }, 5000);
              } else {
                  throw new Error("Failed to save configuration");
              }
          } catch(err) {
              alert("Error saving configuration: " + err.message);
              saveBtn.disabled = false;
              saveBtn.innerHTML = 'Save & Restart';
          }
      }

      function openDictionaryModal() {
        document.getElementById("dictionary-modal").style.display = "flex";
        setTimeout(
          () => document.getElementById("dict-search-input").focus(),
          100,
        );
      }
      function closeDictionaryModal() {
        document.getElementById("dictionary-modal").style.display = "none";
      }

      function printDictionary() {
        // Find all unchecked print toggles and hide their parent containers
        const toggles = document.querySelectorAll('.print-toggle-cb');
        const hiddenContainers = [];
        
        toggles.forEach(cb => {
            if (!cb.checked) {
                const container = cb.closest('.print-container');
                if (container) {
                    container.classList.add('no-print');
                    hiddenContainers.push(container);
                }
            }
        });
        
        document.body.classList.add("print-dict");
        window.print();
        
        // Restore visibility after printing finishes
        setTimeout(() => {
            document.body.classList.remove("print-dict");
            hiddenContainers.forEach(container => container.classList.remove('no-print'));
        }, 500);
      }

      async function searchDictionary() {
        const inputField = document.getElementById("dict-search-input");
        const word = inputField.value.trim();
        const container = document.getElementById("dictionary-content");
        const teacherModel = document.getElementById(
          "teacher-provider-select",
        ).value;

        if (!word) return;

        container.innerHTML = `<div class="system-message">Looking up "${word}"... <div class="loader"></div></div>`;

        let endpoint = "/ai/generate";
        if (teacherModel === "gemini") endpoint = "/ai/gemini";
        if (teacherModel === "sarvam") endpoint = "/ai/sarvam";
        if (teacherModel === "huggingface") endpoint = "/ai/hf";

        try {
          const prompt = `As an expert English Dictionary, analyze the following word/phrase: "${word}".
                Output ONLY valid JSON with the following fields: 
                - "word": The word or phrase itself
                - "phonetic": Phonetic spelling/pronunciation guide
                - "partOfSpeech": noun, verb, adjective, etc.
                - "definition": A beautiful, highly accurate, easy-to-understand contextual definition
                - "verbForms": A JSON array containing Exactly 5 objects ONLY if the word can be used as a verb. Format each object as: {"form": "V1 (Base)", "word": "English verb", "hi": "Hindi translation", "te": "Telugu translation"}. If it is not a verb, return an empty array [].
                - "tenseExamples": A JSON object with keys "present", "past", and "future". Each key should contain an object with "english" (the sentence), "hindi" (Hindi translation of the sentence), and "telugu" (Telugu translation).
                - "synonyms": A JSON array of 3-5 accurate synonyms
                - "antonyms": A JSON array of 3-5 antonyms (if applicable, else empty array)
                DO NOT include markdown formatting or backticks.`;

          const response = await fetch(
            `${endpoint}?message=${encodeURIComponent(prompt)}`,
          );
          const data = await response.json();
          const generation = data.generation || "";

          let dictObj = null;
          try {
            let rawJson = generation
              .replace(/\`\`\`json/g, "")
              .replace(/\`\`\`/g, "")
              .trim();
            dictObj = JSON.parse(rawJson);
          } catch (e) {
            throw { error: "Bad JSON response from AI" };
          }
          
          const wrapWordsForTTS = (text) => {
             if (!text) return "";
             return text.split(/\s+/).map(w => `<span class="tts-word">${w}</span>`).join(" ");
          };

          container.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <div>
                            <h2 style="margin:0 0 5px 0; color:#1e293b; font-size:2.2rem;">${dictObj.word}</h2>
                            <div style="color:#64748b; font-size:1.1rem; display:flex; gap:10px; align-items:center;">
                                <span>${dictObj.phonetic || ""}</span>
                                <span style="background:#f1f5f9; padding:2px 8px; border-radius:4px; font-size:0.9rem; color:#475569;">${dictObj.partOfSpeech}</span>
                            </div>
                        </div>
                        <div style="display:flex; gap:10px;">
                            <button onclick="printDictionary()" style="font-size:1rem; background:#f1f5f9; border-radius:8px; padding:0 15px; height:50px; color:#475569; font-weight:600; border:none; cursor:pointer;">üñ®Ô∏è Print</button>
                            <button class="btn-speak-sentence" style="font-size:1.5rem; background:#fdf2f8; border-radius:50%; width:50px; height:50px; color:#db2777; border:none; cursor:pointer;" onclick="speak('${dictObj.word.replace(/'/g, "\\'")}', 'en-US', this)">üîä</button>
                        </div>
                    </div>
                    
                    <div class="print-container print-bg-strip" style="position:relative; background:#f8fafc; padding:15px; border-radius:8px; border-left:4px solid #db2777; margin-top:20px;">
                        <label class="no-print" style="position:absolute; top:10px; right:10px; font-size:0.8rem; color:#64748b; display:flex; align-items:center; gap:4px; cursor:pointer;"><input type="checkbox" class="print-toggle-cb" checked> Print</label>
                        <h4 style="margin:0 0 10px 0; color:#0f172a;">Definition</h4>
                        <p style="margin:0; font-size:1.1rem; color:#334155;">${dictObj.definition}</p>
                    </div>
                    
                    ${
                      dictObj.verbForms && dictObj.verbForms.length === 5
                        ? `
                    <div class="print-container" style="margin-top:20px; position:relative;">
                        <label class="no-print" style="position:absolute; top:0px; right:0px; font-size:0.8rem; color:#64748b; display:flex; align-items:center; gap:4px; cursor:pointer;"><input type="checkbox" class="print-toggle-cb" checked> Print</label>
                        <h4 style="margin:0 0 10px 0; color:#0f172a;">Verb Forms</h4>
                        <div class="print-bg-strip" style="border:1px solid #fef08a; background:#fefce8; border-radius:8px; overflow:hidden;">
                            <table style="width:100%; border-collapse:collapse; text-align:left; font-size:0.95rem;">
                              <thead>
                                <tr style="background:#fef9c3; color:#854d0e;">
                                  <th style="padding:8px 12px; border-bottom:1px solid #fde047; width:20%;">Form</th>
                                  <th class="lang-en" style="padding:8px 12px; border-bottom:1px solid #fde047; width:26%;">English</th>
                                  <th class="lang-hi" style="padding:8px 12px; border-bottom:1px solid #fde047; width:27%;">Hindi</th>
                                  <th class="lang-te" style="padding:8px 12px; border-bottom:1px solid #fde047; width:27%;">Telugu</th>
                                </tr>
                              </thead>
                              <tbody>
                                ${dictObj.verbForms.map((vf, idx) => `
                                  <tr style="border-bottom:${idx===4 ? 'none' : '1px solid #fef08a'};">
                                    <td style="padding:6px 12px; font-weight:600; color:#ca8a04;">${vf.form || "Form"}</td>
                                    <td class="lang-en" style="padding:6px 12px; color:#854d0e; font-weight:500;">
                                        <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                                            <span class="tts-container">${wrapWordsForTTS(vf.word)}</span>
                                            <button class="btn-speak-sentence no-print" style="flex-shrink:0; background:transparent; border:none; color:#ca8a04; cursor:pointer; padding:0; font-size:0.9rem;" onclick="speak('${(vf.word || "").replace(/'/g, "\\'")}', 'en-US', this, this.previousElementSibling)">üîä</button>
                                        </div>
                                    </td>
                                    <td class="lang-hi" style="padding:6px 12px; color:#a16207; font-size:0.9rem;">
                                        <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                                            <span class="tts-container">${wrapWordsForTTS(vf.hi)}</span>
                                            <button class="btn-speak-sentence no-print" style="flex-shrink:0; background:transparent; border:none; color:#ca8a04; cursor:pointer; padding:0; font-size:0.9rem;" onclick="speak('${(vf.hi || "").replace(/'/g, "\\'")}', 'hi-IN', this, this.previousElementSibling)">üîä</button>
                                        </div>
                                    </td>
                                    <td class="lang-te" style="padding:6px 12px; color:#a16207; font-size:0.9rem;">
                                        <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                                            <span class="tts-container">${wrapWordsForTTS(vf.te)}</span>
                                            <button class="btn-speak-sentence no-print" style="flex-shrink:0; background:transparent; border:none; color:#ca8a04; cursor:pointer; padding:0; font-size:0.9rem;" onclick="speak('${(vf.te || "").replace(/'/g, "\\'")}', 'te-IN', this, this.previousElementSibling)">üîä</button>
                                        </div>
                                    </td>
                                  </tr>
                                `).join("")}
                              </tbody>
                            </table>
                        </div>
                    </div>
                    `
                        : ""
                    }
                    
                    <div class="print-container" style="margin-top:20px; position:relative;">
                        <label class="no-print" style="position:absolute; top:0px; right:0px; font-size:0.8rem; color:#64748b; display:flex; align-items:center; gap:4px; cursor:pointer;"><input type="checkbox" class="print-toggle-cb" checked> Print</label>
                        <h4 style="margin:0 0 10px 0; color:#0f172a;">Tense Examples</h4>
                        ${['present', 'past', 'future'].map(tense => {
                            const ex = dictObj.tenseExamples && dictObj.tenseExamples[tense];
                            if(!ex) return "";
                            return `
                            <div class="print-bg-strip" style="background:#f1f5f9; padding:15px; border-radius:8px; margin-bottom:10px;">
                                <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:5px;">
                                    <div>
                                        <strong style="text-transform:capitalize; color:#3b82f6; font-size:1.1rem; display:block;">${tense} Tense</strong>
                                        <span class="lang-en tts-container" style="display:inline-block; margin-top:4px; font-size:1.05rem; color:#1e293b;">${wrapWordsForTTS(ex.english)}</span>
                                    </div>
                                    <button class="btn-speak-sentence" style="flex-shrink:0; font-size:1.2rem; background:#e0e7ff; border-radius:50%; width:35px; height:35px; color:#4338ca; display:flex; align-items:center; justify-content:center; border:none; cursor:pointer;" onclick="speak('${ex.english.replace(/'/g, "\\'")}', 'en-US', this, this.previousElementSibling.querySelector('.lang-en'))">üîä</button>
                                </div>
                                
                                <div class="lang-hi" style="display:flex; align-items:flex-start; gap:8px; margin-bottom:4px; margin-top:8px;">
                                    <div style="flex-grow:1; font-size:0.95rem; color:#475569;"><strong>Hindi:</strong> <span class="tts-container">${wrapWordsForTTS(ex.hindi)}</span></div>
                                    <button class="btn-speak-sentence" style="flex-shrink:0; font-size:1rem; background:#fce7f3; border-radius:50%; width:24px; height:24px; color:#be185d; display:flex; align-items:center; justify-content:center; border:none; cursor:pointer; padding:0;" onclick="speak('${ex.hindi.replace(/'/g, "\\'")}', 'hi-IN', this, this.previousElementSibling.querySelector('.tts-container'))">üîä</button>
                                </div>
                                <div class="lang-te" style="display:flex; align-items:flex-start; gap:8px;">
                                    <div style="flex-grow:1; font-size:0.95rem; color:#475569;"><strong>Telugu:</strong> <span class="tts-container">${wrapWordsForTTS(ex.telugu)}</span></div>
                                    <button class="btn-speak-sentence" style="flex-shrink:0; font-size:1rem; background:#fce7f3; border-radius:50%; width:24px; height:24px; color:#be185d; display:flex; align-items:center; justify-content:center; border:none; cursor:pointer; padding:0;" onclick="speak('${ex.telugu.replace(/'/g, "\\'")}', 'te-IN', this, this.previousElementSibling.querySelector('.tts-container'))">üîä</button>
                                </div>
                            </div>`;
                        }).join("")}
                    </div>
                    
                    <div class="no-print" style="margin-top:20px; text-align:right;">
                        <label for="dict-advanced-model-select" style="font-size:0.85rem; color:#64748b; font-weight:600; margin-right:5px;">Advanced Model:</label>
                        <select id="dict-advanced-model-select" style="padding:6px 12px; border-radius:6px; border:1px solid #cbd5e1; font-size:0.85rem; color:#475569; background:#f8fafc; outline:none; cursor:pointer;">
                            <option value="openai">OpenAI</option>
                            <option value="gemini">Gemini</option>
                            <option value="sarvam">Sarvam</option>
                            <option value="huggingface" selected>Hugging Face (Recommended)</option>
                            <option value="grok">Grok</option>
                        </select>
                    </div>
                    
                    <div id="dict-advanced-tools" class="no-print" style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;">
                        <button id="btn-dict-more-tenses" onclick="fetch12TensesForDictionary('${dictObj.word.replace(/'/g, "\\'")}')" style="flex:1; min-width:200px; padding:10px; background:#e2e8f0; border:1px dashed #94a3b8; color:#475569; border-radius:8px; cursor:pointer; font-weight:600; font-size:1rem; transition:background 0.2s;">‚ú® View All 12 Tenses</button>
                        <button id="btn-dict-voice" onclick="fetchVoicesForDictionary('${dictObj.word.replace(/'/g, "\\'")}')" style="flex:1; min-width:200px; padding:10px; background:#fce7f3; border:1px dashed #f472b6; color:#db2777; border-radius:8px; cursor:pointer; font-weight:600; font-size:1rem; transition:background 0.2s;">üé≠ Active/Passive Voice</button>
                    </div>
                    <!-- Container for the injected advanced grammar tools -->
                    <div id="dict-12-tenses-container"></div>
                    <div id="dict-voices-container"></div>
                    
                    <div style="display:flex; gap:20px; margin-top:20px;">
                        ${
                          dictObj.synonyms && dictObj.synonyms.length > 0
                            ? `
                        <div style="flex:1; background:#f0fdf4; padding:15px; border-radius:8px;">
                            <h4 style="margin:0 0 10px 0; color:#166534;">Synonyms</h4>
                            <div style="display:flex; flex-wrap:wrap; gap:8px;">
                                ${dictObj.synonyms.map((s) => `<span style="background:white; padding:4px 10px; border-radius:20px; border:1px solid #bbf7d0; font-size:0.9rem; color:#15803d cursor:pointer;" onclick="document.getElementById('dict-search-input').value='${s}'; searchDictionary();">${s}</span>`).join("")}
                            </div>
                        </div>`
                            : ""
                        }
                        
                        ${
                          dictObj.antonyms && dictObj.antonyms.length > 0
                            ? `
                        <div style="flex:1; background:#fef2f2; padding:15px; border-radius:8px;">
                            <h4 style="margin:0 0 10px 0; color:#991b1b;">Antonyms</h4>
                            <div style="display:flex; flex-wrap:wrap; gap:8px;">
                                ${dictObj.antonyms.map((a) => `<span style="background:white; padding:4px 10px; border-radius:20px; border:1px solid #fecaca; font-size:0.9rem; color:#b91c1c; cursor:pointer;" onclick="document.getElementById('dict-search-input').value='${a}'; searchDictionary();">${a}</span>`).join("")}
                            </div>
                        </div>`
                            : ""
                        }
                    </div>
                `;

          // Save it to history
          saveHistory("OTHER", {
            type: "DICTIONARY_LOOKUP",
            word: dictObj.word,
            definition: dictObj.definition,
          });
        } catch (err) {
          showBackendError(container, err);
        }
      }

      async function fetch12TensesForDictionary(word) {
        const btn = document.getElementById("btn-dict-more-tenses");
        const container = document.getElementById("dict-12-tenses-container");
        if (!btn || !container) return;

        btn.style.display = "none";
        container.innerHTML = `<div class="loader" style="margin:20px auto;"></div><p style="text-align:center; color:#64748b;">Generating the 12-Tense matrix...</p>`;

        const advModel = document.getElementById("dict-advanced-model-select");
        const selectedModel = advModel ? advModel.value : "openai";
        
        let endpoint = "/ai/generate";
        if (selectedModel === "gemini") endpoint = "/ai/gemini";
        if (selectedModel === "sarvam") endpoint = "/ai/sarvam";
        if (selectedModel === "huggingface") endpoint = "/ai/hf";
        if (selectedModel === "grok") endpoint = "/ai/grok";

        try {
          const prompt = `Provide example sentences showing the usage of the English word "${word}" across all 12 English tenses. 
MUST be returned in EXACTLY this grammatical order: Simple Present, Present Continuous, Present Perfect, Present Perfect Continuous, Simple Past, Past Continuous, Past Perfect, Past Perfect Continuous, Simple Future, Future Continuous, Future Perfect, Future Perfect Continuous.
Output ONLY a strict JSON array of 12 objects. Format: [{"tense": "Simple Present (etc)", "en": "English sentence", "hi": "Hindi translation", "te": "Telugu translation"}]`;

          const response = await fetch(`${endpoint}?message=${encodeURIComponent(prompt)}`);
          const data = await response.json();
          if (data.error) throw new Error(data.error);

          let rawJson = (data.generation || "[]").trim().replace(/[\x00-\x1F]/g, " ");
          rawJson = rawJson.replace(/```json/gi, "").replace(/```/g, "").trim();
          const arrMatch = rawJson.match(/\[[\s\S]*\]/);
          if (arrMatch) rawJson = arrMatch[0];
          
          const tensesList = JSON.parse(rawJson);
          
          const wrapWordsForTTS = (text) => {
             if (!text) return "";
             return text.split(/\s+/).map(w => `<span class="tts-word">${w}</span>`).join(" ");
          };

          // Build a responsive, beautiful table
          let tableHtml = `
            <div class="print-container" style="position:relative; margin-top:20px;">
              <label class="no-print" style="position:absolute; top:12px; right:15px; font-size:0.8rem; color:#64748b; display:flex; align-items:center; gap:4px; cursor:pointer;"><input type="checkbox" class="print-toggle-cb" checked> Print</label>
              <div class="print-bg-strip" style="border-radius:8px; overflow:hidden; border:1px solid #e2e8f0; background:white;">
                <h4 style="margin:0; padding:15px; background:#f8fafc; color:#0f172a; border-bottom:1px solid #e2e8f0;">‚ú® All 12 Tenses matrix</h4>
                <div style="overflow-x:auto;">
                  <table style="width:100%; border-collapse:collapse; text-align:left; font-size:0.95rem;">
                    <thead>
                    <tr style="background:#f1f5f9; color:#475569;">
                      <th style="padding:12px 15px; border-bottom:2px solid #e2e8f0; width:15%;">Tense</th>
                      <th class="lang-en" style="padding:12px 15px; border-bottom:2px solid #e2e8f0; width:28%; color:#4338ca;">English</th>
                      <th class="lang-hi" style="padding:12px 15px; border-bottom:2px solid #e2e8f0; width:28%; color:#d97706;">Hindi</th>
                      <th class="lang-te" style="padding:12px 15px; border-bottom:2px solid #e2e8f0; width:28%; color:#059669;">Telugu</th>
                    </tr>
                  </thead>
                  <tbody>
          `;

          tensesList.forEach((ex, idx) => {
            const rowBg = idx % 2 === 0 ? "white" : "#f8fafc";
            tableHtml += `
              <tr style="background:${rowBg}; border-bottom:1px solid #e2e8f0;">
                <td style="padding:12px 15px; font-weight:600; color:#334155; vertical-align:top;">${ex.tense || "Unknown"}</td>
                
                <td class="lang-en" style="padding:12px 15px; vertical-align:top;">
                  <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:8px;">
                    <span style="color:#1e293b;" class="tts-container">${wrapWordsForTTS(ex.en)}</span>
                    <button class="btn-speak-sentence" style="flex-shrink:0; font-size:1rem; background:#e0e7ff; border-radius:50%; width:24px; height:24px; color:#4338ca; display:flex; align-items:center; justify-content:center; border:none; cursor:pointer; padding:0;" onclick="speak('${(ex.en || "").replace(/'/g, "\\'")}', 'en-US', this, this.previousElementSibling)">üîä</button>
                  </div>
                </td>
                
                <td class="lang-hi" style="padding:12px 15px; vertical-align:top;">
                  <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:8px;">
                    <span style="color:#b45309;" class="tts-container">${wrapWordsForTTS(ex.hi)}</span>
                    <button class="btn-speak-sentence" style="flex-shrink:0; font-size:1rem; background:#fef3c7; border-radius:50%; width:24px; height:24px; color:#b45309; display:flex; align-items:center; justify-content:center; border:none; cursor:pointer; padding:0;" onclick="speak('${(ex.hi || "").replace(/'/g, "\\'")}', 'hi-IN', this, this.previousElementSibling)">üîä</button>
                  </div>
                </td>
                
                <td class="lang-te" style="padding:12px 15px; vertical-align:top;">
                  <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:8px;">
                    <span style="color:#047857;" class="tts-container">${wrapWordsForTTS(ex.te)}</span>
                    <button class="btn-speak-sentence" style="flex-shrink:0; font-size:1rem; background:#d1fae5; border-radius:50%; width:24px; height:24px; color:#047857; display:flex; align-items:center; justify-content:center; border:none; cursor:pointer; padding:0;" onclick="speak('${(ex.te || "").replace(/'/g, "\\'")}', 'te-IN', this, this.previousElementSibling)">üîä</button>
                  </div>
                </td>
              </tr>
            `;
          });

          tableHtml += `</tbody></table></div></div></div>`;
          container.innerHTML = tableHtml;

          // Remove the top 3 basic tenses so the user only sees the clean 12-tense table
          const basicTensesBlock = container.parentElement.querySelector("div[style*='margin-top:20px']");
          if(basicTensesBlock && basicTensesBlock.innerHTML.includes("Tense Examples")) {
             basicTensesBlock.querySelector("div").style.display = "none";
          }

        } catch (err) {
          console.error("12 Tenses Error:", err);
          container.innerHTML = `<p style="color:#ef4444; font-size:0.95rem; text-align:center; padding:10px; background:#fee2e2; border-radius:8px;">‚ö†Ô∏è Failed to generate tenses. Reason: ${err.message}</p>`;
          btn.style.display = "block";
        }
      }

      async function fetchVoicesForDictionary(word) {
        const btn = document.getElementById("btn-dict-voice");
        const container = document.getElementById("dict-voices-container");
        if (!btn || !container) return;

        btn.style.display = "none";
        container.innerHTML = `<div class="loader" style="margin:20px auto;"></div><p style="text-align:center; color:#64748b;">Generating Active and Passive voice examples...</p>`;

        const advModel = document.getElementById("dict-advanced-model-select");
        const selectedModel = advModel ? advModel.value : "openai";
        
        let endpoint = "/ai/generate";
        if (selectedModel === "gemini") endpoint = "/ai/gemini";
        if (selectedModel === "sarvam") endpoint = "/ai/sarvam";
        if (selectedModel === "huggingface") endpoint = "/ai/hf";
        if (selectedModel === "grok") endpoint = "/ai/grok";

        try {
          const prompt = `Provide 2 clear examples showing the word "${word}" used in Active Voice, and 2 examples of it used in Passive Voice.
Output ONLY a strict JSON array of 4 objects. Format: [{"voice": "Active Voice", "en": "English sentence", "hi": "Hindi translation", "te": "Telugu translation"}]`;

          const response = await fetch(`${endpoint}?message=${encodeURIComponent(prompt)}`);
          const data = await response.json();
          if (data.error) throw new Error(data.error);

          let rawJson = (data.generation || "[]").trim().replace(/[\x00-\x1F]/g, " ");
          rawJson = rawJson.replace(/```json/gi, "").replace(/```/g, "").trim();
          const arrMatch = rawJson.match(/\[[\s\S]*\]/);
          if (arrMatch) rawJson = arrMatch[0];
          
          const voiceList = JSON.parse(rawJson);
          
          const wrapWordsForTTS = (text) => {
             if (!text) return "";
             return text.split(/\s+/).map(w => `<span class="tts-word">${w}</span>`).join(" ");
          };

          let tableHtml = `
            <div class="print-container" style="position:relative; margin-top:20px;">
              <label class="no-print" style="position:absolute; top:12px; right:15px; font-size:0.8rem; color:#be185d; display:flex; align-items:center; gap:4px; cursor:pointer;"><input type="checkbox" class="print-toggle-cb" checked> Print</label>
              <div class="print-bg-strip" style="border-radius:8px; overflow:hidden; border:1px solid #fbcfe8; background:white;">
                <h4 style="margin:0; padding:15px; background:#fdf2f8; color:#be185d; border-bottom:1px solid #fbcfe8;">üé≠ Active vs Passive Voice</h4>
                <div style="overflow-x:auto;">
                  <table style="width:100%; border-collapse:collapse; text-align:left; font-size:0.95rem;">
                    <thead>
                    <tr style="background:#fdf2f8; color:#be185d;">
                      <th style="padding:12px 15px; border-bottom:2px solid #fbcfe8; width:15%;">Voice Form</th>
                      <th class="lang-en" style="padding:12px 15px; border-bottom:2px solid #fbcfe8; width:28%;">English</th>
                      <th class="lang-hi" style="padding:12px 15px; border-bottom:2px solid #fbcfe8; width:28%;">Hindi</th>
                      <th class="lang-te" style="padding:12px 15px; border-bottom:2px solid #fbcfe8; width:28%;">Telugu</th>
                    </tr>
                  </thead>
                  <tbody>
          `;

          voiceList.forEach((ex, idx) => {
            const rowBg = idx % 2 === 0 ? "white" : "#fdf2f8";
            tableHtml += `
              <tr style="background:${rowBg}; border-bottom:1px solid #fbcfe8;">
                <td style="padding:12px 15px; font-weight:600; color:#9d174d; vertical-align:top;">${ex.voice || "Voice"}</td>
                
                <td class="lang-en" style="padding:12px 15px; vertical-align:top;">
                  <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:8px;">
                    <span style="color:#1e293b;" class="tts-container">${wrapWordsForTTS(ex.en)}</span>
                    <button class="btn-speak-sentence" style="flex-shrink:0; font-size:1rem; background:#fce7f3; border-radius:50%; width:24px; height:24px; color:#be185d; display:flex; align-items:center; justify-content:center; border:none; cursor:pointer; padding:0;" onclick="speak('${(ex.en || "").replace(/'/g, "\\'")}', 'en-US', this, this.previousElementSibling)">üîä</button>
                  </div>
                </td>
                
                <td class="lang-hi" style="padding:12px 15px; vertical-align:top;">
                  <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:8px;">
                    <span style="color:#b45309;" class="tts-container">${wrapWordsForTTS(ex.hi)}</span>
                    <button class="btn-speak-sentence" style="flex-shrink:0; font-size:1rem; background:#fef3c7; border-radius:50%; width:24px; height:24px; color:#b45309; display:flex; align-items:center; justify-content:center; border:none; cursor:pointer; padding:0;" onclick="speak('${(ex.hi || "").replace(/'/g, "\\'")}', 'hi-IN', this, this.previousElementSibling)">üîä</button>
                  </div>
                </td>
                
                <td class="lang-te" style="padding:12px 15px; vertical-align:top;">
                  <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:8px;">
                    <span style="color:#047857;" class="tts-container">${wrapWordsForTTS(ex.te)}</span>
                    <button class="btn-speak-sentence" style="flex-shrink:0; font-size:1rem; background:#d1fae5; border-radius:50%; width:24px; height:24px; color:#047857; display:flex; align-items:center; justify-content:center; border:none; cursor:pointer; padding:0;" onclick="speak('${(ex.te || "").replace(/'/g, "\\'")}', 'te-IN', this, this.previousElementSibling)">üîä</button>
                  </div>
                </td>
              </tr>
            `;
          });

          tableHtml += `</tbody></table></div></div>`;
          container.innerHTML = tableHtml;

        } catch (err) {
          console.error("Voice Generation Error:", err);
          container.innerHTML = `<p style="color:#ef4444; font-size:0.95rem; text-align:center; padding:10px; background:#fee2e2; border-radius:8px;">‚ö†Ô∏è Failed to generate voice examples. Reason: ${err.message}</p>`;
          btn.style.display = "block";
        }
      }

      function init() {
        fetchUser();

        // Restore global TTS Speed setting
        const savedTtsSpeed = localStorage.getItem("globalTtsSpeed");
        const ttsSelect = document.getElementById("tts-speed-select");
        if (ttsSelect) {
          if (savedTtsSpeed) ttsSelect.value = savedTtsSpeed;
          ttsSelect.addEventListener("change", (e) => {
            localStorage.setItem("globalTtsSpeed", e.target.value);
            stopAllAudio(); // Stop active speaking if speed changed
          });
        }
        
        // Setup Custom Voices
        speechSynthesis.onvoiceschanged = populateVoices;
        populateVoices(); // Call initially in case they are already loaded
        const voiceSelect = document.getElementById("tts-voice-select");
        if (voiceSelect) {
          voiceSelect.addEventListener("change", (e) => {
            localStorage.setItem("globalTtsVoice", e.target.value);
            stopAllAudio();
          });
        }
        
        // Restore global Highlight Speaking setting
        const savedTtsHighlight = localStorage.getItem("globalTtsHighlight");
        const ttsHighlightToggle = document.getElementById("tts-highlight-toggle");
        if (ttsHighlightToggle) {
           if (savedTtsHighlight !== null) ttsHighlightToggle.checked = savedTtsHighlight === "true";
           ttsHighlightToggle.addEventListener("change", (e) => {
              localStorage.setItem("globalTtsHighlight", e.target.checked);
           });
        }

        // Global Language Toggle setup
        const langCheckboxes = document.querySelectorAll("#lang-selector input");
        const updateBodyLangClasses = () => {
          langCheckboxes.forEach(cb => {
             document.body.classList.toggle(`show-${cb.value}`, cb.checked);
          });
        };
        // Run once on load
        updateBodyLangClasses();
        // Listen for changes
        langCheckboxes.forEach(cb => cb.addEventListener('change', updateBodyLangClasses));

        addRow();

        // Re-enable all vocab/quiz buttons when model changes
        document
          .getElementById("vocab-provider-select")
          ?.addEventListener("change", () => {
            document.querySelectorAll(".vocab-trigger-btn").forEach((btn) => {
              btn.textContent = "üìö Vocab";
              btn.disabled = false;
              btn.dataset.generating = "false";
              // Abort active generation if any
              const rowId = btn.closest(".row-action-bar")?.id.split("-")[2];
              if (rowId && state.vocabAbortControllers.has(rowId)) {
                state.vocabAbortControllers.get(rowId).abort();
                state.vocabAbortControllers.delete(rowId);
              }
            });
          });
        document
          .getElementById("teacher-provider-select")
          ?.addEventListener("change", () => {
            // Clear any active quiz generators if teacher model changes mid-flow
            state.quizAbortControllers.forEach((ctrl) => ctrl.abort());
            state.quizAbortControllers.clear();
          });
      }

      let allVoices = [];
      function populateVoices() {
         allVoices = speechSynthesis.getVoices();
         const voiceSelect = document.getElementById("tts-voice-select");
         if (!voiceSelect) return;
         
         const allowedVoices = allVoices.filter(v => {
            const l = v.lang.toLowerCase();
            if (l.startsWith('hi') || l.startsWith('te')) return true;
            if (l.startsWith('en')) {
               return l.includes('in') || l.includes('us') || l.includes('gb') || l.includes('uk') || v.name.toLowerCase().includes('india');
            }
            return false;
         });
         
         // Priority sorting: Indian first, then US, then UK. Within those, Natural first.
         allowedVoices.sort((a, b) => {
            const aL = a.lang.toLowerCase(); const bL = b.lang.toLowerCase();
            const aN = a.name.toLowerCase(); const bN = b.name.toLowerCase();
            
            const aIn = aL.includes('in') || aN.includes('india');
            const bIn = bL.includes('in') || bN.includes('india');
            const aUS = aL.includes('us'); const bUS = bL.includes('us');
            const aUK = aL.includes('gb') || aL.includes('uk'); const bUK = bL.includes('gb') || bL.includes('uk');

            const aScore = aIn ? 1 : (aUS ? 2 : (aUK ? 3 : 4));
            const bScore = bIn ? 1 : (bUS ? 2 : (bUK ? 3 : 4));

            if (aScore !== bScore) return aScore - bScore;
            
            const aNat = aN.includes("premium") || aN.includes("enhanced") || aN.includes("google") || aN.includes("rishi") || aN.includes("veena") || aN.includes("lekha");
            const bNat = bN.includes("premium") || bN.includes("enhanced") || bN.includes("google") || bN.includes("rishi") || bN.includes("veena") || bN.includes("lekha");
            
            if (aNat && !bNat) return -1;
            if (!aNat && bNat) return 1;

            return a.name.localeCompare(b.name);
         });
         
         // Preserve existing default option and populate
         const defaultOp = voiceSelect.options[0];
         voiceSelect.innerHTML = "";
         voiceSelect.appendChild(defaultOp);
         
         allowedVoices.forEach(voice => {
            const option = document.createElement("option");
            option.value = voice.voiceURI; // Use voiceURI as unique identifier
            
            // Try to guess gender from common names or tags, fallback to "Voice"
            let gender = "Voice";
            const nameLower = voice.name.toLowerCase();
            if (nameLower.includes("female") || nameLower.includes("woman") || nameLower.includes("girl") || nameLower.includes("samantha") || nameLower.includes("victoria") || nameLower.includes("moira") || nameLower.includes("tessa") || nameLower.includes("veena") || nameLower.includes("lekha")) gender = "Female";
            else if (nameLower.includes("male") || nameLower.includes("man") || nameLower.includes("boy") || nameLower.includes("alex") || nameLower.includes("daniel") || nameLower.includes("fred") || nameLower.includes("rishi")) gender = "Male";
            
            // Tag natural premium voices
            const isNatural = nameLower.includes("premium") || nameLower.includes("enhanced") || nameLower.includes("google") || nameLower.includes("rishi") || nameLower.includes("veena") || nameLower.includes("lekha");
            const naturalBadge = isNatural ? "‚ú® Natural " : "";
            
            // Check region
            const l = voice.lang.toLowerCase();
            const isIndian = l.includes('in') || nameLower.includes('india');
            const prefix = isIndian ? "üáÆüá≥ " : (l.includes('us') ? "üá∫üá∏ " : (l.includes('gb') || l.includes('uk') ? "üá¨üáß " : "üåê "));
            const langCode = voice.lang.substring(0,2).toUpperCase();
            
            option.textContent = `[${langCode}] ${prefix}${naturalBadge}${voice.name} (${gender})`;
            voiceSelect.appendChild(option);
         });
         
         const savedVoice = localStorage.getItem("globalTtsVoice");
         if (savedVoice) {
            voiceSelect.value = savedVoice;
         }
      }

      function autoResize(textarea) {
        // Only run auto-expand if the user hasn't manually overridden the height
        if (!textarea.style.height || textarea.style.height === "auto" || parseInt(textarea.style.height) < textarea.scrollHeight) {
           textarea.style.height = "auto";
           textarea.style.height = textarea.scrollHeight + "px";
        }
      }
      
      // --- Custom Full-Width Resizer Logic ---
      let isResizing = false;
      let currentTextarea = null;
      let startY = 0;
      let startHeight = 0;

      function initResize(e) {
          isResizing = true;
          currentTextarea = e.currentTarget.closest('.input-row').querySelector('textarea');
          if (!currentTextarea) return;
          
          startY = e.clientY;
          // Use getComputedStyle to strictly grab the height mapping to the CSS definition
          startHeight = parseFloat(window.getComputedStyle(currentTextarea).height) || 80;
          
          // Disable flex so explicit pixel heights are respected by the browser
          currentTextarea.style.flex = "none";
          
          window.addEventListener('mousemove', doResize);
          window.addEventListener('mouseup', stopResize);
          
          // CRITICAL: Prevent text highlighting from breaking the mouse move sequence
          document.body.style.userSelect = 'none';
          document.body.style.cursor = 'row-resize';
          e.preventDefault();
      }

      function doResize(e) {
          if (!isResizing || !currentTextarea) return;
          const newHeight = startHeight + (e.clientY - startY);
          if (newHeight >= 45) {
              currentTextarea.style.height = newHeight + "px";
          }
      }

      function stopResize(e) {
          isResizing = false;
          currentTextarea = null;
          window.removeEventListener('mousemove', doResize);
          window.removeEventListener('mouseup', stopResize);
          
          document.body.style.userSelect = '';
          document.body.style.cursor = '';
      }

      async function logoutUser(btn) {
        const originalText = btn.innerHTML;
        btn.innerHTML = "‚è≥ Logging out...";
        btn.disabled = true;

        try {
          // Spring security default logout must be a POST when CSRF enabled, but we disabled it, so GET or POST is fine. We use POST.
          const response = await fetch("/logout", {
            method: "POST",
          });

          if (response.redirected) {
            window.location.href = response.url;
          } else {
            window.location.href = "/login.html?logout";
          }
        } catch (err) {
          alert("Failed to log out.");
          btn.innerHTML = originalText;
          btn.disabled = false;
        }
      }

      function addRow() {
        const id = Date.now();
        const wrapper = document.createElement("div");
        wrapper.className = "row-wrapper";
        wrapper.id = `wrapper-${id}`;
        wrapper.innerHTML = `
                <div class="story-btn-wrapper">
                    <button class="btn-add btn-story" title="Generate AI Story" onclick="toggleStoryLevels(this)">üìñ</button>
                    <div class="story-level-selector">
                        <button class="story-level-btn" onclick="generateAiStory('${id}', 1)">Level 1 <span>Simple sentences</span></button>
                        <button class="story-level-btn" onclick="generateAiStory('${id}', 2)">Level 2 <span>Primary level</span></button>
                        <button class="story-level-btn" onclick="generateAiStory('${id}', 3)">Level 3 <span>Intermediate</span></button>
                        <button class="story-level-btn" onclick="generateAiStory('${id}', 4)">Level 4 <span>Advanced English</span></button>
                        <button class="story-level-btn" onclick="generateAiStory('${id}', 5)">Level 5 <span>Expert/Literary</span></button>
                    </div>
                </div>
                <div class="input-row">
                    <textarea placeholder="Enter text or upload image..." 
                              oninput="autoResize(this)"
                              onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); handleTranslate('${id}'); }"
                              style="width: 100%; min-height: 80px; margin-bottom: 0;"></textarea>
                    <div class="resize-handle" onmousedown="initResize(event)" title="Drag down to resize textarea"></div>
                    
                    <div class="input-actions" style="display: flex; justify-content: flex-end; gap: 10px;">
                        <button class="btn-add" title="Translate" onclick="handleTranslate('${id}')">üöÄ</button>
                        <button class="btn-add" style="background:#6366f1" title="Grammar & Tone Check" onclick="handleGrammarCheck('${id}')">‚úÖ</button>
                        <button class="btn-add" style="background:#f59e0b" title="English Teacher (Better Way)" onclick="handleBetterWay('${id}')">‚ú®</button>
                        <button class="btn-add" style="background:#3b82f6" title="Scan Image (OCR)" onclick="triggerOcr('${id}')">üì∑</button>
                        <button class="btn-add" style="background:#10b981" title="Add Row" onclick="addRow()">+</button>
                        <button class="btn-add btn-remove" title="Remove Row" onclick="removeRow('${id}')">‚àí</button>
                    </div>
                    <input type="file" id="file-${id}" style="display:none" accept="image/*" onchange="handleOcr(${id}, this)">
                </div>
                <div id="action-bar-container-${id}"></div>
                <div id="results-${id}" class="translation-box"></div>
            `;
        document.getElementById("input-container").appendChild(wrapper);
      }

      function removeRow(id) {
        const row = document.getElementById(`wrapper-${id}`);
        if (document.querySelectorAll(".row-wrapper").length > 1) {
          row.remove();
          state.rowVocabulary.delete(id);
          refreshVocabTable();
        } else {
          // If it's the last row, just clear it and its vocab
          row.querySelector("textarea").value = "";
          document.getElementById(`results-${id}`).innerHTML = "";
          state.rowVocabulary.delete(id);
          refreshVocabTable();
        }
      }

      function triggerOcr(id) {
        document.getElementById(`file-${id}`).click();
      }

      function toggleStoryLevels(btn) {
        const selector = btn.nextElementSibling;
        selector.classList.toggle("show");
        // Close if click outside
        const closeOnClickOutside = (e) => {
          if (!btn.contains(e.target) && !selector.contains(e.target)) {
            selector.classList.remove("show");
            document.removeEventListener("click", closeOnClickOutside);
          }
        };
        setTimeout(
          () => document.addEventListener("click", closeOnClickOutside),
          10,
        );
      }

      async function generateAiStory(id, level) {
        const resultsDiv = document.getElementById(`results-${id}`);
        const inputField = document
          .getElementById(`wrapper-${id}`)
          .querySelector("textarea");
        const teacherModel = document.getElementById(
          "teacher-provider-select",
        ).value;

        // Hide selector
        const selector = document.querySelector(
          `#wrapper-${id} .story-level-selector`,
        );
        if (selector) selector.classList.remove("show");

        resultsDiv.innerHTML = `<div class="system-message">Writing a Level ${level} Story... <div class="loader"></div></div>`;

        const levelDescriptions = {
          1: "preschool level, extremely simple sentences (max 4), basic vocabulary.",
          2: "primary school level, simple narrative, 5-6 sentences.",
          3: "middle school level, intermediate paragraph, expressive vocabulary.",
          4: "high school level, advanced vocabulary, complex sentence structures.",
          5: "literary/expert level, sophisticated themes, rich vocabulary, and nuanced storytelling.",
        };

        const randomTopics = [
          "an unexpected friendship",
          "a magical discovery",
          "overcoming a small fear",
          "a day in the life of a clever animal",
          "a mystery solved through teamwork",
          "a space adventure",
          "learning a new skill",
          "helping a neighbor",
          "a brave little explorer",
          "finding something lost",
          "a funny misunderstanding",
          "a secret garden",
          "a rainy day surprise",
          "a journey across the mountains",
        ];
        const randomTopic =
          randomTopics[Math.floor(Math.random() * randomTopics.length)];

        const prompt = `Write a very small, realistic story with a good meaning and a moral. 
            The story must be about: ${randomTopic}.
            The story should be at Level ${level}: ${levelDescriptions[level]}
            Output ONLY valid JSON with two string fields: "headline" (a catchy title for the story) and "story" (the story text). DO NOT include markdown formatting or backticks.`;

        let endpoint = "/ai/generate";
        if (teacherModel === "gemini") endpoint = "/ai/gemini";
        if (teacherModel === "sarvam") endpoint = "/ai/sarvam";
        if (teacherModel === "huggingface") endpoint = "/ai/hf";

        try {
          const response = await fetch(
            `${endpoint}?message=${encodeURIComponent(prompt)}`,
          );
          const data = await response.json();
          const generation = data.generation || "";

          let storyObj = null;
          try {
            let rawJson = generation
              .replace(/```json/g, "")
              .replace(/```/g, "")
              .trim();
            storyObj = JSON.parse(rawJson);
          } catch (e) {
            storyObj = { headline: "Story", story: generation };
          }

          if (storyObj && storyObj.story) {
            const headline = storyObj.headline || "Story";
            const formattedStory = `[${headline}]\n\n${storyObj.story.trim()}`;
            inputField.value = formattedStory;
            autoResize(inputField);
            resultsDiv.innerHTML = `<div class="system-message">‚ú® Level ${level} story generated! Clicking üöÄ to translate...</div>`;
            saveHistory("STORY", {
              level: level,
              headline: headline,
              story: storyObj.story.trim(),
            });
            setTimeout(() => handleTranslate(id), 1200);
          } else {
            const errMsg =
              data.error ||
              "Failed to generate story. Please check your API keys.";
            showBackendError(resultsDiv, data);
          }
        } catch (err) {
          showBackendError(resultsDiv, err);
        }
      }

      async function handleOcr(id, input) {
        const file = input.files[0];
        if (!file) return;

        const resultsDiv = document.getElementById(`results-${id}`);
        const inputField = document
          .getElementById(`wrapper-${id}`)
          .querySelector("textarea");

        resultsDiv.innerHTML = `<div class="system-message">Scanning Image... <div class="loader"></div></div>`;

        const formData = new FormData();
        formData.append("file", file);

        try {
          const response = await fetch("/ai/ocr", {
            method: "POST",
            body: formData,
          });
          const data = await response.json();

          if (data.text) {
            inputField.value = data.text;
            resultsDiv.innerHTML = `<div class="system-message">‚ú® Text extracted! Click üöÄ to translate.</div>`;
          } else {
            resultsDiv.innerHTML = `<div class="system-message" style="color:red">No text found in image.</div>`;
          }
        } catch (err) {
          showBackendError(resultsDiv, err);
        } finally {
          input.value = ""; // Reset file input
        }
      }

      async function fetchGoogleTranslate(text, targetLang) {
        try {
          const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=${targetLang}&dt=t&q=${encodeURIComponent(text)}`;
          const response = await fetch(url);
          const data = await response.json();
          return data[0].map((x) => x[0]).join("");
        } catch (err) {
          console.error("Google Translate Error:", err);
          return "Translation Error";
        }
      }

      async function handleTranslate(id) {
        await processInput(id, "translate");
      }

      async function handleBetterWay(id) {
        await processInput(id, "better");
      }

      async function handleGrammarCheck(id) {
        const wrapper = document.getElementById(`wrapper-${id}`);
        const input = wrapper.querySelector("textarea");
        const resultsDiv = document.getElementById(`results-${id}`);
        const teacherModel = document.getElementById(
          "teacher-provider-select",
        ).value;
        const text = input.value.trim();

        if (!text) {
          alert("Please enter some text to check grammar.");
          return;
        }

        // Clear previous translation results but keep vocab table
        resultsDiv.innerHTML = `<div class="system-message">üßê Analyzing Grammar & Tone... <div class="loader"></div></div>`;

        let endpoint = "/ai/generate";
        if (teacherModel === "gemini") endpoint = "/ai/gemini";
        if (teacherModel === "sarvam") endpoint = "/ai/sarvam";
        if (teacherModel === "huggingface") endpoint = "/ai/hf";

        try {
          const prompt = `As an expert English grammar teacher, analyze the following text: "${text}".
                Check for any grammatical, spelling, or punctuation errors. Analyze the tone.
                Output ONLY valid JSON with the following fields: 
                - "status": either "Correct" or "Incorrect"
                - "correction": the fully corrected text (if it was already correct, just return the original text, but try to improve it slightly if possible)
                - "explanation": a friendly, encouraging explanation of the mistakes made and why the correction is better
                - "tone": a short description of the tone (e.g. "Formal", "Casual", "Urgent")
                DO NOT include markdown formatting or backticks.`;

          const response = await fetch(
            `${endpoint}?message=${encodeURIComponent(prompt)}`,
          );
          const data = await response.json();
          const generation = data.generation || "";

          let resultObj = null;
          try {
            let rawJson = generation
              .replace(/\`\`\`json/g, "")
              .replace(/\`\`\`/g, "")
              .trim();
            resultObj = JSON.parse(rawJson);
          } catch (e) {
            console.error("Failed to parse Grammar JSON", e);
            throw { error: "Bad JSON response from AI" };
          }

          const statusColor =
            resultObj.status.toLowerCase() === "correct"
              ? "#10b981"
              : "#ef4444";

          resultsDiv.innerHTML = `
                    <div style="background:#f8fafc; padding:15px; border-radius:8px; border-left:4px solid ${statusColor}; margin-bottom:10px;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <h3 style="margin:0; color:${statusColor}; font-weight:800; display:flex; align-items:center; gap:8px;">
                                ${resultObj.status.toLowerCase() === "correct" ? "‚úÖ Perfect!" : "‚ö†Ô∏è Needs Correction"}
                            </h3>
                            <span style="background:#e2e8f0; padding:4px 8px; border-radius:12px; font-size:0.8rem; font-weight:600; color:#475569;">
                                Tone: ${resultObj.tone || "Neutral"}
                            </span>
                        </div>
                        <p style="margin:10px 0; font-size:0.95rem; color:#334155; line-height:1.5;">${resultObj.explanation}</p>
                        ${
                          resultObj.status.toLowerCase() !== "correct"
                            ? `
                        <div style="background:white; padding:10px; border-radius:6px; border:1px solid #e2e8f0; margin-top:10px;">
                            <strong style="color:var(--primary); font-size:0.85rem; text-transform:uppercase; letter-spacing:0.05em;">Corrected Version:</strong>
                            <p style="margin:5px 0 0 0; font-weight:600; color:#0f172a; font-size:1.05rem;">${resultObj.correction}</p>
                        </div>
                        `
                            : ""
                        }
                    </div>
                `;

          // Save it to history
          saveHistory("OTHER", {
            type: "GRAMMAR_CHECK",
            original: text,
            analysis: resultObj,
          });

          // If it was wrong, update the input box to the corrected version
          if (
            resultObj.correction &&
            resultObj.status.toLowerCase() !== "correct"
          ) {
            input.value = resultObj.correction;
            autoResize(input);
          }
        } catch (err) {
          showBackendError(resultsDiv, err);
        }
      }

      async function processInput(id, mode) {
        const wrapper = document.getElementById(`wrapper-${id}`);
        const input = wrapper.querySelector("textarea");
        const resultsDiv = document.getElementById(`results-${id}`);
        const provider =
          mode === "better"
            ? document.getElementById("teacher-provider-select").value
            : document.getElementById("provider-select").value;
        const text = input.value.trim();

        const selectedLangs = Array.from(
          document.querySelectorAll("#lang-selector input:checked"),
        ).map((cb) => cb.value);

        if (!text || selectedLangs.length === 0) return;

        // Clear stale vocabulary for this row on every new translation
        state.rowVocabulary.delete(id);
        const existingActionBar = document.getElementById(`action-bar-${id}`);
        if (existingActionBar) {
          const vocabBtn =
            existingActionBar.querySelector(".vocab-trigger-btn");
          if (vocabBtn) {
            vocabBtn.textContent = "üìö Vocab";
            vocabBtn.disabled = false;
          }
        }
        // Also clear the vocab table display
        refreshVocabTable();

        resultsDiv.innerHTML = `<div class="system-message">${mode === "better" ? "Refining your English..." : "Thinking..."} <div class="loader"></div></div>`;
        if (mode === "better") {
          try {
            // Step 1: Tell AI to be an English teacher: correct mistakes, simplify for kids, and make it professional
            const prompt = `As an expert English teacher, take this input: "${text}".
                    1. Correct any grammatical or spelling mistakes.
                    2. Rewrite it in the absolute BEST, most natural, and simple way so even a child could understand, but keep it professional.
                    Output ONLY a JSON object: {"original": "${text}", "perfected": "...", "explanation": "..."}`;

            let endpoint = "/ai/generate";
            if (provider === "gemini") endpoint = "/ai/gemini";
            if (provider === "sarvam") endpoint = "/ai/sarvam";
            if (provider === "huggingface") endpoint = "/ai/hf";
            if (provider === "grok") endpoint = "/ai/grok";

            const response = await fetch(
              `${endpoint}?message=${encodeURIComponent(prompt)}`,
            );
            const data = await response.json();
            if (data.error) throw data;

            let rawJson = data.generation || "{}";
            let match = rawJson.match(/\{[\s\S]*\}/);
            if (match) rawJson = match[0];

            // Cleanup control characters
            rawJson = rawJson.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g, "");

            let result;
            try {
              result = JSON.parse(rawJson);
            } catch (e) {
              console.error("JSON parse fail:", e, rawJson);
              throw new Error(
                "AI returned invalid JSON: " + rawJson.substring(0, 50),
              );
            }

            if (!result.perfected)
              throw new Error(
                "Could not refine sentence. AI output: " +
                  rawJson.substring(0, 50),
              );

            // Step 2: Use Google Translate to translate this PERFECTED sentence
            const transPromises = selectedLangs.map(async (l) => {
              const translation = await fetchGoogleTranslate(
                result.perfected,
                l,
              );
              return [l, translation];
            });
            const transResults = await Promise.all(transPromises);
            const translations = Object.fromEntries(transResults);

            // Show results + perfection badge
            resultsDiv.innerHTML = `
                        <div style="background:var(--primary-light); padding:10px; border-radius:8px; margin-bottom:10px; border-left:4px solid var(--primary)">
                            <small style="color:var(--primary); font-weight:800; text-transform:uppercase">‚ú® Better Way (Refined)</small>
                            <p style="margin:5px 0; font-weight:600;">${result.perfected}</p>
                        </div>
                    `;
            renderTranslations(resultsDiv, translations, id);
            appendRowActionBar(id, result.perfected);
            saveHistory("BETTER_WAY", {
              original: text,
              refined: result.perfected,
              translations: translations,
            });
          } catch (err) {
            showBackendError(resultsDiv, err);
          }
          return;
        }

        // mode === 'translate' logic (existing Google switch)
        if (provider === "google") {
          // Fetch translations from Google Translate in parallel
          try {
            const transPromises = selectedLangs.map(async (l) => {
              const translation = await fetchGoogleTranslate(text, l);
              return [l, translation];
            });
            const transResults = await Promise.all(transPromises);
            const translations = Object.fromEntries(transResults);

            renderTranslations(resultsDiv, translations, id);
            appendRowActionBar(id, text);
            saveHistory("TRANSLATE", {
              original: text,
              translations: translations,
            });
          } catch (err) {
            showBackendError(resultsDiv, err);
          }
          return;
        }

        // LLM Translation Path
        const langNames = { en: "English", hi: "Hindi", te: "Telugu" };
        const targets = selectedLangs.map((l) => langNames[l]).join(", ");
        const safeText = text
          .replace(/[\r\n]+/g, " ")
          .replace(/"/g, "'")
          .trim();

        // Check for Sarvam large text chunking
        const CHUNK_LIMIT = 200;
        let chunks = [safeText];
        
        if (provider === "sarvam" && safeText.length > CHUNK_LIMIT) {
           // Split by sentence boundaries roughly
           const sentences = safeText.match(/[^.?!]+[.?!]+|\s*[^.?!]+$/g) || [safeText];
           chunks = [];
           let currentChunk = "";
           for (const s of sentences) {
              if ((currentChunk.length + s.length) > CHUNK_LIMIT && currentChunk.length > 0) {
                 chunks.push(currentChunk.trim());
                 currentChunk = s;
              } else {
                 currentChunk += (currentChunk ? " " : "") + s.trim();
              }
           }
           if (currentChunk.trim().length > 0) chunks.push(currentChunk.trim());
        }

        try {
          let endpoint = "/ai/generate";
          if (provider === "huggingface") endpoint = "/ai/hf";
          if (provider === "gemini") endpoint = "/ai/gemini";
          if (provider === "grok") endpoint = "/ai/grok";
          if (provider === "sarvam") endpoint = "/ai/sarvam";

          let finalTranslations = {};
          selectedLangs.forEach(l => finalTranslations[l] = "");
          
          for (let i = 0; i < chunks.length; i++) {
             if (chunks.length > 1) {
                resultsDiv.innerHTML = `<div class="system-message">Translating part ${i+1} of ${chunks.length}... <div class="loader"></div></div>`;
             }
             
             const chunk = chunks[i];
             // Ask ONLY for translations ‚Äî no vocabulary here (user triggers that separately)
             const prompt = `Translate the following text into ${targets}: ${chunk}. Output ONLY raw JSON, no markdown: {${selectedLangs.map((l) => `"${l}": "..."`).join(", ")}}`;
             
             const response = await fetch(
               `${endpoint}?message=${encodeURIComponent(prompt)}`,
             );
             const data = await response.json();
             if (data.error) throw data;

             let rawJson = data.generation || "";
             let match = rawJson.match(/\{[\s\S]*\}/);
             if (match) rawJson = match[0];
             rawJson = rawJson
               .replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g, "")
               .replace(/([^\\])\n/g, "$1 ")
               .replace(/([^\\])\r/g, "$1 ");

             let result;
             try {
               result = JSON.parse(rawJson);
             } catch (parseErr) {
               console.error("Translation JSON parse failed for chunk:", rawJson, parseErr);
               throw new Error("AI response could not be parsed.");
             }

             const parsedTrans = result.translations || result;
             // Merge results
             selectedLangs.forEach(l => {
                if (parsedTrans[l]) {
                   finalTranslations[l] += (finalTranslations[l] ? " " : "") + parsedTrans[l];
                }
             });
          }

          renderTranslations(resultsDiv, finalTranslations, id);
          // Vocab must be clicked explicitly ‚Äî never auto-generate
          appendRowActionBar(id, safeText, false);
          saveHistory("TRANSLATE", {
             original: text,
             translations: finalTranslations,
          });
        } catch (err) {
          if (err.message && err.message.includes("AI response could not be parsed")) {
             resultsDiv.innerHTML = `<div style="color:red">‚ö†Ô∏è AI response could not be parsed. Try Google Translate.</div>`;
          } else {
             showBackendError(resultsDiv, err);
          }
        }
      }

      async function triggerVocabulary(id) {
        const bar = document.getElementById(`action-bar-${id}`);
        const btn = bar ? bar.querySelector(".vocab-trigger-btn") : null;
        const text = bar ? bar.dataset.sourceText : "";
        if (!text) return;

        // If already generating ‚Üí CANCEL
        if (btn && btn.dataset.generating === "true") {
          const ctrl = state.vocabAbortControllers.get(id);
          if (ctrl) ctrl.abort();
          state.vocabAbortControllers.delete(id);
          btn.textContent = "üìö Vocab";
          btn.disabled = false;
          btn.dataset.generating = "false";
          return;
        }

        // Start generating
        const ctrl = new AbortController();
        state.vocabAbortControllers.set(id, ctrl);
        if (btn) {
          btn.textContent = "‚èπ Cancel";
          btn.disabled = false; // keep enabled so user can cancel
          btn.dataset.generating = "true";
        }

        try {
          await fetchLlmVocabulary(
            text,
            (vocab) => {
              updateVocabulary(id, vocab);
            },
            ctrl.signal,
          );
          if (btn && btn.dataset.generating === "true") {
            btn.textContent = "‚úÖ Vocab Done";
            btn.disabled = true;
            btn.dataset.generating = "false";
          }
        } catch (e) {
          if (btn) {
            btn.textContent = "üìö Retry Vocab";
            btn.disabled = false;
            btn.dataset.generating = "false";
          }
        } finally {
          state.vocabAbortControllers.delete(id);
        }
      }

      function appendRowActionBar(id, text, vocabAlreadyDone = false) {
        const container = document.getElementById(`wrapper-${id}`);
        if (!container) return;

        const existing = document.getElementById(`action-bar-${id}`);
        if (existing) existing.remove();

        const bar = document.createElement("div");
        bar.className = "action-bar-container";
        bar.id = `action-bar-${id}`;
        bar.dataset.sourceText = text;
        bar.innerHTML = `
                <div class="row-action-bar">
                    <button class="vocab-trigger-btn ${vocabAlreadyDone ? "done" : ""}" 
                            onclick="triggerVocabulary('${id}')" 
                            ${vocabAlreadyDone ? "disabled" : ""}>
                        ${vocabAlreadyDone ? "‚úÖ Vocab Done" : "üìö Vocab"}
                    </button>
                    <button class="quiz-trigger-btn" onclick="triggerQuiz('${id}')">üìù Quiz</button>
                    <button onclick="toggleRowLayout('${id}', this)">‚ò∞ Layout</button>
                    <button onclick="printRow('${id}')">üñ®Ô∏è Print</button>
                    <div style="display:flex; align-items:center; gap:5px; margin-left:auto; font-size:0.8rem; color:#64748b;">
                        <input type="checkbox" onchange="toggleRowSelect('${id}', this)"> 
                        Select for Print
                    </div>
                </div>
                <div id="quiz-container-${id}" class="quiz-container"></div>
            `;
        container.appendChild(bar);
      }

      async function triggerQuiz(id) {
        const container = document.getElementById(`quiz-container-${id}`);
        if (!container) return;

        // Toggle visibility
        if (
          container.style.display === "block" &&
          !container.innerHTML.includes("Thinking")
        ) {
          container.style.display = "none";
          return;
        }

        container.style.display = "block";

        // Show level selector
        container.innerHTML = `
                <div class="quiz-level-selector">
                    <strong>Select Quiz Level:</strong>
                    <button class="level-btn" onclick="startQuiz('${id}', 1)">Level 1 (Direct)</button>
                    <button class="level-btn" onclick="startQuiz('${id}', 2)">Level 2 (Inference)</button>
                    <button class="level-btn" onclick="startQuiz('${id}', 3)">Level 3 (Contextual)</button>
                    <button class="level-btn" onclick="startQuiz('${id}', 4)">Level 4 (Advanced)</button>
                    <button class="level-btn" onclick="startQuiz('${id}', 5)">Level 5 (Expert)</button>
                </div>
                <div id="quiz-content-${id}"></div>
            `;
      }

      async function startQuiz(id, level) {
        const bar = document.getElementById(`action-bar-${id}`);
        const text = bar ? bar.dataset.sourceText : "";
        const content = document.getElementById(`quiz-content-${id}`);
        if (!text || !content) return;

        // Highlight active level
        const btns = document.querySelectorAll(
          `#quiz-container-${id} .level-btn`,
        );
        btns.forEach((b, i) => b.classList.toggle("active", i + 1 === level));

        content.innerHTML = `<div class="system-message">Generating Level ${level} Quiz... <div class="loader"></div></div>`;

        // Abort previous if any
        if (state.quizAbortControllers.has(id))
          state.quizAbortControllers.get(id).abort();
        const ctrl = new AbortController();
        state.quizAbortControllers.set(id, ctrl);

        try {
          await fetchLlmQuiz(
            text,
            level,
            (quiz) => {
              renderQuiz(id, quiz);
            },
            ctrl.signal,
          );
        } catch (e) {
          if (e.name !== "AbortError") {
            showBackendError(content, err);
          }
        } finally {
          state.quizAbortControllers.delete(id);
        }
      }

      async function fetchLlmQuiz(text, level, callback, signal) {
        const levelPrompts = {
          1: "Level 1: Ask 3 questions based STRICTLY on the facts explicitly stated in the text.",
          2: "Level 2: Ask 3 questions that require basic inference or detail recall from the text.",
          3: "Level 3: Ask 3 questions that connect the text to broader general knowledge (contextual extension).",
          4: "Level 4: Ask 3 questions about deep logic, themes, or complex implications of the ideas in the text.",
          5: "Level 5: Ask 3 expert-level questions requiring advanced critical thinking and synthesis of the concepts.",
        };

        const prompt = `As an AI Tutor, generate a quiz for this text: "${text}".
            ${levelPrompts[level]}
            
            Return ONLY a valid JSON array of 3 questions with this exact structure:
            [{"q":"question text","options":["opt1","opt2","opt3","opt4"],"correct":0,"explanation":"why opt1 is correct"}]
            (correct index is 0-3)`;

        const teacherModel = document.getElementById(
          "teacher-provider-select",
        ).value;
        let endpoint = "/ai/generate"; // Default to OpenAI
        if (teacherModel === "gemini") endpoint = "/ai/gemini";
        if (teacherModel === "sarvam") endpoint = "/ai/sarvam";
        if (teacherModel === "huggingface") endpoint = "/ai/hf";

        const response = await fetch(
          `${endpoint}?message=${encodeURIComponent(prompt)}`,
          { signal },
        );
        const data = await response.json();

        let rawJson = (data.generation || "[]").trim();
        const arrMatch = rawJson.match(/\[[\s\S]*\]/);
        if (arrMatch) rawJson = arrMatch[0];

        try {
          const quiz = JSON.parse(rawJson);
          callback(quiz);
        } catch (e) {
          const errMsg =
            data.error || "Invalid format from AI or backend failure.";
          console.error("Quiz Parse Error", e, rawJson);
          throw new Error(errMsg);
        }
      }

      function renderQuiz(id, questions) {
        const content = document.getElementById(`quiz-content-${id}`);
        if (!content || !questions || questions.length === 0) return;

        content.innerHTML = questions
          .map(
            (q, qIndex) => `
                <div class="quiz-question" id="q-${id}-${qIndex}">
                    <h4>${qIndex + 1}. ${q.q}</h4>
                    <div class="quiz-choices">
                        ${q.options
                          .map(
                            (opt, oIndex) => `
                            <button class="choice-btn" onclick="checkAnswer('${id}', ${qIndex}, ${oIndex}, ${q.correct}, '${q.explanation.replace(/'/g, "\\'")}')">
                                ${opt}
                            </button>
                        `,
                          )
                          .join("")}
                    </div>
                    <div class="quiz-feedback" id="feedback-${id}-${qIndex}"></div>
                </div>
            `,
          )
          .join("");
      }

      function checkAnswer(
        id,
        qIndex,
        selectedIndex,
        correctIndex,
        explanation,
      ) {
        const questionDiv = document.getElementById(`q-${id}-${qIndex}`);
        const feedbackDiv = document.getElementById(`feedback-${id}-${qIndex}`);
        const btns = questionDiv.querySelectorAll(".choice-btn");

        // Disable all buttons for this question
        btns.forEach((btn) => btn.classList.add("disabled"));
        btns.forEach((btn) => (btn.onclick = null));

        // Highlight answers
        btns[selectedIndex].classList.add(
          selectedIndex === correctIndex ? "correct" : "incorrect",
        );
        if (selectedIndex !== correctIndex) {
          btns[correctIndex].classList.add("correct");
        }

        // Show feedback
        feedbackDiv.style.display = "block";
        feedbackDiv.style.color =
          selectedIndex === correctIndex ? "#166534" : "#991b1b";
        feedbackDiv.innerHTML = `${selectedIndex === correctIndex ? "‚úÖ Correct!" : "‚ùå Incorrect."} ${explanation}`;
      }

      function toggleRowLayout(id, btn) {
        const resultsDiv = document.getElementById(`results-${id}`);
        const box = resultsDiv
          ? resultsDiv.querySelector(".inner-translation-box")
          : null;
        if (box) {
          const isGrid = box.classList.toggle("side-by-side");
          btn.textContent = isGrid ? "‚äû Grid ON" : "‚ò∞ Layout";
          btn.classList.toggle("active", isGrid);
        }
      }

      function toggleRowSelect(id, cb) {
        const wrapper = document.getElementById(`wrapper-${id}`);
        if (wrapper) wrapper.classList.toggle("print-selected", cb.checked);
      }

      function printRow(id) {
        const selected = document.querySelectorAll(
          ".row-wrapper.print-selected",
        );
        if (selected.length > 0) {
          // User has multiple rows checked ‚Äî print all of them together
          window.print();
        } else {
          // No rows selected ‚Äî print just this row temporarily
          const allWrappers = document.querySelectorAll(".row-wrapper");
          const target = document.getElementById(`wrapper-${id}`);
          if (target) target.classList.add("print-selected");
          window.print();
          if (target) target.classList.remove("print-selected");
        }
      }

      async function fetchLlmVocabulary(text, callback, signal) {
        // Stop words to exclude ‚Äî keep only meaningful content words
        const stopWords = new Set([
          "the",
          "and",
          "with",
          "into",
          "one",
          "for",
          "was",
          "that",
          "this",
          "are",
          "have",
          "had",
          "has",
          "not",
          "but",
          "from",
          "they",
        ]);
        const contentWords = [
          ...new Set(
            text
              .split(/\s+/)
              .map((w) =>
                w
                  .replace(/[^a-zA-Z\u0900-\u097F\u0C00-\u0C7F]/g, "")
                  .trim()
                  .toLowerCase(),
              )
              .filter((w) => w.length > 2 && !stopWords.has(w)), // Lowered to 2 to include "cat", "dog", etc.
          ),
        ].slice(0, 12);

        if (contentWords.length === 0) {
          const vocabBody = document.getElementById("vocab-body");
          const dictSection = document.getElementById("dictionary-section");
          if (vocabBody) {
            vocabBody.innerHTML = `<tr><td colspan="4" style="color:#64748b;text-align:center;padding:10px">‚ÑπÔ∏è No significant vocabulary words found in this text. Try a longer sentence.</td></tr>`;
            if (dictSection) dictSection.style.display = "block";
          }
          return;
        }

        let prompt = `You are an expert, multi-lingual language teacher. Translate these English vocabulary words into highly accurate Hindi and Telugu. For the meaning, provide ONLY the direct English dictionary definition (a short phrase). DO NOT include example sentences. IMPORTANT: Be extremely careful with translations of colors (e.g. "red" MUST map to "‡∞é‡∞∞‡±Å‡∞™‡±Å" and not "‡∞ö‡±Ü‡∞∞‡±Å‡∞ï‡±Å").
Words: [${contentWords.join(", ")}]
Output ONLY a valid JSON array (no markdown, no extra text):
[{"en": "word", "meaning": "direct English dictionary meaning (no sentences)", "hi": "accurate Hindi translation", "te": "accurate Telugu translation"}]`;

        try {
          const vocabProvider = document.getElementById(
            "vocab-provider-select",
          ).value;
          
          // Use Google Translate API specifically (bypassing AI LLMs)
          if (vocabProvider === "google") {
            const vocabBody = document.getElementById("vocab-body");
            const dictSection = document.getElementById("dictionary-section");
            if (vocabBody) {
               vocabBody.innerHTML = `<tr><td colspan="6" style="text-align:center;padding:20px"><div class="loader"></div> Translating via Google...</td></tr>`;
               if (dictSection) dictSection.style.display = "block";
            }
          
            const vocab = [];
            for (const word of contentWords) {
              try {
                const resHi = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=hi&dt=t&dt=bd&dt=md&q=${encodeURIComponent(word)}`, { signal });
                const dataHi = await resHi.json();
                
                const resTe = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=te&dt=t&dt=bd&q=${encodeURIComponent(word)}`, { signal });
                const dataTe = await resTe.json();
                
                const extractWords = (data) => {
                  let results = [];
                  if (data && data[0] && data[0][0] && data[0][0][0]) {
                     results.push(data[0][0][0]);
                  }
                  if (data && data[1]) {
                     for (let pos of data[1]) {
                        if (pos[1]) {
                           for (let w of pos[1]) {
                              if (!results.includes(w)) results.push(w);
                              if (results.length >= 3) return results.join(", ");
                           }
                        }
                     }
                  }
                  return results.join(", ");
                };

                let engMeaning = word; // Default to the word itself if no definition found
                if (dataHi && dataHi[12] && dataHi[12][0] && dataHi[12][0][1] && dataHi[12][0][1][0] && dataHi[12][0][1][0][0]) {
                   engMeaning = dataHi[12][0][1][0][0];
                }

                vocab.push({
                  en: word,
                  meaning: engMeaning,
                  hi: extractWords(dataHi),
                  te: extractWords(dataTe)
                });
                
                // Add a small 100ms delay to space out fetches to avoid 429 rate limit
                await new Promise(resolve => setTimeout(resolve, 100));
              } catch (err) {
                console.error("Google Translation API error for word", word, err);
                const vocabBody = document.getElementById("vocab-body");
                if (vocabBody && vocab.length === 0) {
                  vocabBody.innerHTML = `<tr><td colspan="6" style="color:#ef4444;text-align:center;padding:10px">‚ö†Ô∏è Google API Rate Limit Exceeded (429). Please try again later or switch to an AI model.</td></tr>`;
                  return;
                }
              }
            }
            callback(vocab);
            return;
          }

          let endpoint = "/ai/generate";
          if (vocabProvider === "huggingface") endpoint = "/ai/hf";
          if (vocabProvider === "gemini") endpoint = "/ai/gemini";
          if (vocabProvider === "grok") endpoint = "/ai/grok";
          if (vocabProvider === "sarvam") endpoint = "/ai/sarvam";

          for (let attempt = 1; attempt <= 2; attempt++) {
            const response = await fetch(
              `${endpoint}?message=${encodeURIComponent(prompt)}`,
              { signal }, // eslint-disable-line no-undef
            );
            const data = await response.json();

            // Check for provider-level error before attempting parse
            if (data.error) {
              const vocabBody = document.getElementById("vocab-body");
              const dictSection = document.getElementById("dictionary-section");
              const short = data.error.includes("429")
                ? "‚ö†Ô∏è API quota exceeded. Switch to a different Vocab model."
                : `‚ö†Ô∏è ${data.error.substring(0, 120)}`;
              if (vocabBody) {
                vocabBody.innerHTML = `<tr><td colspan="6" style="color:#ef4444;text-align:center;padding:10px">${short}</td></tr>`;
                if (dictSection) dictSection.style.display = "block";
              }
              return;
            }

            let rawJson = (data.generation || "[]").trim();
            
            // Aggressive markdown block stripping
            rawJson = rawJson.replace(/```json/gi, "").replace(/```/g, "").trim();
            
            // Extract JSON array from response
            const arrMatch = rawJson.match(/\[[\s\S]*\]/);
            if (arrMatch) rawJson = arrMatch[0];
            
            // Repair literal newlines inside strings
            rawJson = rawJson
              .replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g, "")
              .replace(/([^\\])\n/g, "$1 ")
              .replace(/([^\\])\r/g, "$1 ");

            try {
              const vocab = JSON.parse(rawJson);
              callback(vocab);
              return; // Success! Exit loop
            } catch (parseError) {
              console.error("Parse attempt failed:", rawJson, parseError);
              if (attempt === 2) {
                // Formatting rawJson for clean HTML reading
                const cleanJson = rawJson.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                const vocabBody = document.getElementById("vocab-body");
                const dictSection = document.getElementById("dictionary-section");
                if (vocabBody) {
                  vocabBody.innerHTML = `<tr><td colspan="6" style="text-align:center;padding:15px"><div style="color:#ef4444; font-weight:bold; margin-bottom:10px;">‚ö†Ô∏è AI returned invalid JSON format.</div><div style="background:#fee2e2; padding:10px; border-radius:6px; font-family:monospace; font-size:0.8rem; overflow-x:auto; text-align:left; color:#7f1d1d;">${cleanJson}</div><div style="margin-top:10px; font-size:0.85rem; color:#64748b;">Try selecting OpenAI or Sarvam, which output cleaner JSON schema.</div></td></tr>`;
                  if (dictSection) dictSection.style.display = "block";
                }
                return;
              } else {
                // Retry attempt: tell the AI specifically what went wrong
                prompt += `\n\nWARNING: Your previous response was INVALID JSON! It threw a parse error. You must output a raw, strict JSON array without any markdown formatting. Let's try again.`;
              }
            }
          }
        } catch (e) {
          console.error("Vocab fetch failed entirely", e);
        }
      }

      function updateVocabulary(id, vocab) {
        if (!vocab || vocab.length === 0) return;
        state.rowVocabulary.set(id, vocab);
        refreshVocabTable();
      }

      function refreshVocabTable() {
        const dictSection = document.getElementById("dictionary-section");
        const header = document.getElementById("vocab-header");
        const body = document.getElementById("vocab-body");
        if (!body) return;

        // Update header to include Select column
        if (header) {
          header.innerHTML =
            '<th><input type="checkbox" id="vocab-select-all" title="Select All"></th><th class="lang-en">English</th><th class="lang-en">Meaning</th><th class="lang-hi">Hindi</th><th class="lang-te">Telugu</th>';
          const selectAllCb = header.querySelector("#vocab-select-all");
          if (selectAllCb) {
            selectAllCb.onchange = (e) => {
              const allCbs = body.querySelectorAll(".vocab-print-cb");
              allCbs.forEach((cb) => {
                cb.checked = e.target.checked;
                cb.closest("tr").classList.toggle(
                  "vocab-print-selected",
                  e.target.checked,
                );
              });
            };
          }
        }

        body.innerHTML = "";
        let hasAny = false;

        state.rowVocabulary.forEach((vocabArr) => {
          vocabArr.forEach((entry) => {
            hasAny = true;
            const tr = document.createElement("tr");

            // Add checkbox td
            const selectTd = document.createElement("td");
            selectTd.innerHTML =
              '<input type="checkbox" class="vocab-print-cb">';
            const rowCb = selectTd.querySelector("input");
            rowCb.onchange = (e) => {
              tr.classList.toggle("vocab-print-selected", e.target.checked);
              // Update select-all state
              const allCbs = body.querySelectorAll(".vocab-print-cb");
              const allChecked = Array.from(allCbs).every((c) => c.checked);
              const selectAllCb = document.getElementById("vocab-select-all");
              if (selectAllCb) selectAllCb.checked = allChecked;
            };
            tr.appendChild(selectTd);

            const fields = [
              entry.en || "",
              entry.meaning || "",
              entry.hi || "",
              entry.te || "",
            ];

            const langs = ["en-US", null, "hi-IN", "te-IN"];
            const classes = ["lang-en", "lang-en", "lang-hi", "lang-te"];
            fields.forEach((val, i) => {
              const td = document.createElement("td");
              td.className = classes[i];
              
              if (langs[i] && val) {
                const sp = createWordElement(val, langs[i]);
                td.appendChild(sp);
              } else {
                td.textContent = val;
                td.style.color = "#64748b";
                td.style.fontStyle = "italic";
                td.style.fontSize = "0.85rem";
              }
              tr.appendChild(td);
            });
            body.appendChild(tr);
          });
        });

        if (dictSection) dictSection.style.display = hasAny ? "block" : "none";
      }

      function createWordElement(word, langCode) {
        const span = document.createElement("span");
        span.className = "word";
        span.innerText = word;

        const tooltip = document.createElement("div");
        tooltip.className = "tooltip";
        
        const posDiv = document.createElement("div");
        posDiv.className = "tooltip-pos";
        posDiv.innerText = "...";
        
        // Fetch POS data (Only for English words)
        if (langCode === "en-US") {
           fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(word)}`)
             .then(res => res.json())
             .then(data => {
                if (data && data[0] && data[0].meanings && data[0].meanings[0]) {
                   posDiv.innerText = data[0].meanings[0].partOfSpeech;
                } else {
                   posDiv.innerText = "Word";
                }
             })
             .catch(() => posDiv.innerText = "Word");
        } else {
           posDiv.style.display = "none";
        }
        
        const btnGroup = document.createElement("div");
        btnGroup.className = "tooltip-btn-group";

        const speakBtn = createBtn("üîä", (e) =>
          speak(word, langCode, e.currentTarget),
        );
        const usageBtn = createBtn("üìù", () => showUsageExamples(word));
        const tenseBtn = createBtn("‚è≥", () => showTenses(word));
        const imgBtn = createBtn("üñº", () =>
          window.open(
            `https://www.google.com/search?tbm=isch&q=${encodeURIComponent(word)}`,
            "_blank",
          ),
        );
        const vidBtn = createBtn("üé•", () =>
          window.open(
            `https://www.youtube.com/results?search_query=${encodeURIComponent(word)}`,
            "_blank",
          ),
        );

        btnGroup.append(speakBtn, usageBtn, tenseBtn, imgBtn, vidBtn);
        tooltip.append(posDiv, btnGroup);
        span.appendChild(tooltip);
        return span;
      }

      function createBtn(label, onClick) {
        const btn = document.createElement("button");
        btn.className = "tooltip-btn";
        btn.innerText = label;
        btn.onclick = onClick;
        return btn;
      }

      let currentUtterance = null;
      let activeSpeakBtn = null;

      function stopAllAudio() {
        speechSynthesis.cancel();
        if (activeSpeakBtn) {
          activeSpeakBtn.innerText = "üîä";
          activeSpeakBtn = null;
        }
        // Clear any lingering highlights
        document.querySelectorAll(".tts-highlight").forEach(el => el.classList.remove("tts-highlight"));
      }

      function speak(text, lang, btn, container) {
        // If already speaking THIS button -> STOP
        if (activeSpeakBtn === btn && speechSynthesis.speaking) {
          stopAllAudio();
          return;
        }

        // Always stop previous before starting new
        stopAllAudio();

        const isHighlightEnabled = document.getElementById("tts-highlight-toggle")?.checked;
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = lang;
        
        // Attach custom voice if selected and matches core language prefix (en, hi, te)
        // If they chose a custom voice, its language should match the target language
        // to prevent Safari/Chrome from spewing gibberish trying to speak English with a Hindi voice component.
        const voiceSelect = document.getElementById("tts-voice-select");
        if (voiceSelect && voiceSelect.value && allVoices.length > 0) {
           const customVoice = allVoices.find(v => v.voiceURI === voiceSelect.value);
           if (customVoice && customVoice.lang.substring(0, 2) === lang.substring(0, 2)) {
              utterance.voice = customVoice;
           } else if (customVoice && customVoice.lang.includes('en') && lang.startsWith('en')) {
              // Both english
              utterance.voice = customVoice;
           } else {
              // The user's selected voice does not match the text's language (e.g., they picked an English voice but clicked a Hindi word).
              // We should try to find an Indian voice for the text language to apply instead.
              const fallbackVoice = allVoices.find(v => v.lang.startsWith(lang.substring(0, 2)) && v.lang.includes('IN'));
              if(fallbackVoice) utterance.voice = fallbackVoice;
           }
        }

        const speedSelect = document.getElementById("tts-speed-select");
        if (speedSelect) {
          utterance.rate = parseFloat(speedSelect.value) || 1.0;
        }

        let wordSpans = [];
        if (isHighlightEnabled && container) {
            wordSpans = Array.from(container.querySelectorAll('.trans-word, .tts-word'));
        }

        if (wordSpans.length > 0) {
            utterance.onboundary = (event) => {
                if (event.name !== 'word') return;
                
                // Clear previous
                wordSpans.forEach(s => s.classList.remove("tts-highlight"));
                
                // Estimate the word index based on charIndex. 
                // The text from speech utterance doesn't perfectly map to DOM sometimes, 
                // so we use a simple heuristic: count words up to charIndex.
                const textUpToBoundary = text.substring(0, event.charIndex);
                const wordIndex = (textUpToBoundary.match(/\S+/g) || []).length;
                
                if (wordSpans[wordIndex]) {
                    wordSpans[wordIndex].classList.add("tts-highlight");
                }
            };
        }

        currentUtterance = utterance;

        if (btn) {
          activeSpeakBtn = btn;
          btn.innerText = "‚èπ";
        }

        utterance.onend = () => {
          if (activeSpeakBtn === btn) {
            btn.innerText = "üîä";
            activeSpeakBtn = null;
          }
          if (wordSpans.length > 0) {
             wordSpans.forEach(s => s.classList.remove("tts-highlight"));
          }
        };

        utterance.onerror = () => {
          if (activeSpeakBtn === btn) {
            btn.innerText = "üîä";
            activeSpeakBtn = null;
          }
          if (wordSpans.length > 0) {
             wordSpans.forEach(s => s.classList.remove("tts-highlight"));
          }
        };

        speechSynthesis.speak(utterance);
      }

      async function showTenses(word) {
        const modal = document.getElementById("usage-modal");
        const modalWord = document.getElementById("modal-word-display");
        const modalBody = document.getElementById("modal-body");
        if (!modal) return;
        if (modalWord) modalWord.textContent = word + " (Tenses)";
        modalBody.innerHTML = '<div class="loader"></div>';
        modal.style.display = "flex";

        const generateTenses = async (type) => {
            const isAll = type === 'all';
            modalBody.innerHTML = '<div style="text-align:center; padding: 20px;"><div class="loader"></div><div style="margin-top:15px;font-size:0.95rem;color:#64748b;">Generating ' + (isAll ? 'all 12 grammatical' : '3 basic') + ' tenses with translations...</div></div>';
            
            const prompt = isAll 
              ? `Provide example sentences showing the usage of the English word "${word}" across all 12 English tenses. Offer the English sentence, plus its Hindi and Telugu translations. Output ONLY a strict JSON array of objects: [{"tense": "Simple Present (etc)", "en": "English sentence", "hi": "Hindi translation", "te": "Telugu translation"}]`
              : `Provide example sentences showing the usage of the English word "${word}" across 3 basic tenses (Simple Past, Simple Present, Simple Future). Offer the English sentence, plus its Hindi and Telugu translations. Output ONLY a strict JSON array of objects: [{"tense": "Simple Present (etc)", "en": "English sentence", "hi": "Hindi translation", "te": "Telugu translation"}]`;
            
            try {
              const response = await fetch(`/ai/generate?message=${encodeURIComponent(prompt)}`);
              const data = await response.json();
              let rawJson = (data.generation || '[]').replace(/[\x00-\x1F]/g, " ");
              rawJson = rawJson.replace(/```json/gi, "").replace(/```/g, "").trim();
              const arrMatch = rawJson.match(/\[[\s\S]*\]/);
              if (arrMatch) rawJson = arrMatch[0];

              const examples = JSON.parse(rawJson);
              modalBody.innerHTML = "";
              examples.forEach((ex) => {
                const div = document.createElement("div");
                div.style.cssText = "margin-bottom: 15px; padding: 12px; background: #f8fafc; border-radius: 8px; border-left: 4px solid var(--primary); font-size: 0.95rem; line-height: 1.5;";
                div.innerHTML = `<div style="font-weight: bold; color: var(--primary); border-bottom: 1px solid #e2e8f0; padding-bottom: 5px; margin-bottom: 8px;">${ex.tense || "Tense"}</div>
                                 <div style="margin-bottom: 4px;"><strong style="color: #475569;">EN:</strong> ${ex.en || ""}</div>
                                 <div style="margin-bottom: 4px;"><strong style="color: #475569;">HI:</strong> ${ex.hi || ""}</div>
                                 <div><strong style="color: #475569;">TE:</strong> ${ex.te || ""}</div>`;
                modalBody.appendChild(div);
              });
              
              if (!isAll) {
                 const showMoreBtn = document.createElement("button");
                 showMoreBtn.innerText = "Show All 12 Tenses";
                 showMoreBtn.style.cssText = "margin-top: 15px; padding: 10px 16px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; display: block; width: 100%; font-weight: 500; font-size: 1rem; transition: background 0.2s;";
                 showMoreBtn.onmouseover = () => showMoreBtn.style.background = "var(--primary-dark)";
                 showMoreBtn.onmouseout = () => showMoreBtn.style.background = "var(--primary)";
                 showMoreBtn.onclick = () => generateTenses('all');
                 modalBody.appendChild(showMoreBtn);
              }
            } catch (e) {
              console.error("Parse error tenses", e);
              modalBody.innerHTML = '<p style="color:red; text-align:center; padding: 20px;">Failed to load or parse tenses from AI. Please try again.</p>';
            }
        };

        generateTenses('basic');
      }

      async function showUsageExamples(word) {
        const modal = document.getElementById("usage-modal");
        const modalWord = document.getElementById("modal-word-display"); // matches HTML id
        const modalBody = document.getElementById("modal-body");
        if (!modal) return;
        if (modalWord) modalWord.textContent = word;
        modalBody.innerHTML = '<div class="loader"></div>';
        modal.style.display = "flex";

        try {
          const prompt = `Give 3 short example sentences using the word "${word}" in a natural context. Output ONLY a JSON array of strings: ["sentence1", "sentence2", "sentence3"]`;
          const response = await fetch(
            `/ai/generate?message=${encodeURIComponent(prompt)}`,
          );
          const data = await response.json();
          let rawJson = (data.generation || '["No examples found."]').replace(
            /[\x00-\x1F]/g,
            " ",
          );
          const match = rawJson.match(/\[[\s\S]*\]/);
          if (match) rawJson = match[0];
          const examples = JSON.parse(rawJson);
          modalBody.innerHTML = examples
            .map(
              (e) =>
                `<p style="margin:8px 0;padding:8px;background:#f8fafc;border-radius:6px;border-left:3px solid #6366f1">${e}</p>`,
            )
            .join("");
        } catch (e) {
          modalBody.innerHTML =
            '<p style="color:red">Failed to load examples.</p>';
        }
      }

      function toggleUserMenu(event) {
        event.stopPropagation();
        const menu = document.getElementById("user-dropdown");
        if (menu) {
          menu.classList.toggle("show");
        }
      }

      function toggleSarvamMenu(event, tagEl, text) {
        event.stopPropagation();
        document.querySelectorAll('.sarvam-menu.show').forEach(m => {
           if (m.parentElement !== tagEl) {
              m.classList.remove('show');
              if (m.parentElement && m.parentElement.classList.contains('lang-tag')) {
                 m.parentElement.style.zIndex = "";
              }
           }
        });
        
        let menu = tagEl.querySelector('.sarvam-menu');
        if (!menu) {
           menu = document.createElement('div');
           menu.className = 'sarvam-menu';
           
           const links = [
              { icon: 'üó£Ô∏è', label: 'Text to Speech', url: 'https://dashboard.sarvam.ai/text-to-speech' },
              { icon: 'üëÅÔ∏è', label: 'Vision', url: 'https://dashboard.sarvam.ai/vision' },
              { icon: 'üéôÔ∏è', label: 'Speech to Text', url: 'https://dashboard.sarvam.ai/speech-to-text' },
              { icon: 'üåç', label: 'Translate', url: 'https://dashboard.sarvam.ai/translate' }
           ];
           
           links.forEach(l => {
              const btn = document.createElement('button');
              btn.className = 'sarvam-menu-item';
              btn.innerHTML = `${l.icon} ${l.label}`;
              btn.onclick = (e) => {
                 e.stopPropagation();
                 navigator.clipboard.writeText(text).then(() => {
                    window.open(l.url, '_blank');
                    menu.classList.remove('show');
                    tagEl.style.zIndex = "";
                 }).catch(err => {
                    console.error('Copy failed: ', err);
                    window.open(l.url, '_blank');
                    menu.classList.remove('show');
                    tagEl.style.zIndex = "";
                 });
              };
              menu.appendChild(btn);
           });
           tagEl.appendChild(menu);
        }
        
        const isShowing = menu.classList.toggle('show');
        tagEl.style.zIndex = isShowing ? "9999" : "";
      }

      function closeModal() {
        const modal = document.getElementById("usage-modal");
        if (modal) modal.style.display = "none";
      }

      // Close dropdowns if clicking outside
      document.addEventListener('click', (e) => {
         const userMenu = document.getElementById("user-dropdown");
         if (userMenu && userMenu.classList.contains("show") && !e.target.closest(".user-menu-container")) {
            userMenu.classList.remove("show");
         }
         
         document.querySelectorAll('.sarvam-menu.show').forEach(m => {
            if (!e.target.closest(".lang-tag")) {
               m.classList.remove('show');
               if (m.parentElement && m.parentElement.classList.contains('lang-tag')) {
                  m.parentElement.style.zIndex = "";
               }
            }
         });
      });

      function renderTranslations(container, trans, rowId) {
        container.innerHTML = "";

        const box = document.createElement("div");
        box.className = "translation-box inner-translation-box";

        const allLangs = [
          { k: "en", l: "EN", c: "en-US" },
          { k: "hi", l: "HI", c: "hi-IN" },
          { k: "te", l: "TE", c: "te-IN" },
        ];

        const selectedLangs = Array.from(
          document.querySelectorAll("#lang-selector input:checked"),
        ).map((cb) => cb.value);

        allLangs
          .filter((l) => selectedLangs.includes(l.k))
          .forEach((lang) => {
            const line = document.createElement("div");
            line.className = `translation-line lang-${lang.k}`;

            const text = trans[lang.k] || "";

            const tag = document.createElement("div");
            tag.className = `lang-tag lang-tag-${lang.k}`;
            tag.innerText = lang.l;
            tag.title = "Open Sarvam AI Playground";
            tag.onclick = (e) => toggleSarvamMenu(e, tag, text);

            const textContainer = document.createElement("span");
            textContainer.className = `sentence-text color-${lang.k}`;
            text
              .split(/\s+/)
              .filter((w) => w)
              .forEach((word, i) => {
                if (i > 0) textContainer.append(" ");
                const ws = document.createElement("span");
                ws.className = "trans-word";
                ws.textContent = word;
                ws.dataset.word = word
                  .replace(/[^\p{L}\p{N}]/gu, "")
                  .toLowerCase();
                ws.dataset.lang = lang.k;
                ws.dataset.row = rowId || "";
                ws.onmouseover = () => onWordHover(ws);
                ws.onmouseout = () => onWordOut();
                textContainer.appendChild(ws);
              });

            const speakBtn = document.createElement("button");
            speakBtn.className = "btn-speak-sentence";
            speakBtn.innerHTML = "üîä";
            speakBtn.onclick = (e) => speak(text, lang.c, e.currentTarget, textContainer);

            line.append(tag, textContainer, speakBtn);
            box.appendChild(line);
          });
        container.appendChild(box);
      }

      async function onWordHover(spanEl) {
        onWordOut();
        const rawWord = spanEl.textContent.trim();
        const lang = spanEl.dataset.lang;
        const rowId = parseInt(spanEl.dataset.row);
        if (!rawWord || rawWord.length < 2) return;

        spanEl.classList.add("cross-highlight");

        const parentBox = spanEl.closest(".inner-translation-box");
        if (!parentBox) return;

        const targetLangs =
          lang === "en"
            ? ["hi", "te"]
            : lang === "hi"
              ? ["en", "te"]
              : ["en", "hi"];

        await Promise.all(
          targetLangs.map(async (tl) => {
            const cacheKey = `${rawWord.toLowerCase()}|${tl}`;
            let translated = state.wordTransCache.get(cacheKey);
            if (!translated) {
              try {
                translated = await fetchGoogleTranslate(rawWord, tl);
                state.wordTransCache.set(cacheKey, translated);
              } catch {
                return;
              }
            }
            if (!translated) return;
            const transClean = translated.trim().toLowerCase();
            parentBox
              .querySelectorAll(`.trans-word[data-lang="${tl}"]`)
              .forEach((s) => {
                if (
                  s.textContent.trim().toLowerCase().includes(transClean) ||
                  transClean.includes(s.textContent.trim().toLowerCase())
                ) {
                  s.classList.add("cross-highlight");
                }
              });
          }),
        );
      }

      function onWordOut() {
        document
          .querySelectorAll(".trans-word.cross-highlight")
          .forEach((s) => s.classList.remove("cross-highlight"));
      }

      function toggleFullScreenContainer() {
          const btn = document.getElementById("fullscreen-toggle-btn");
          const isFull = document.body.classList.toggle("fullscreen-mode");
          if (isFull) {
              btn.innerHTML = ">< Shrink";
              btn.style.background = "#0f766e";
          } else {
              btn.innerHTML = "‚ÜîÔ∏è Expand";
              btn.style.background = "#14b8a6";
          }
      }

      init();
    </script>
    
    <!-- Custom Print Footer -->
    <div class="print-only-footer" style="display: none;">
      Authorized by Chandu | www.way2lingolearn.com
    </div>
  </body>
</html>
